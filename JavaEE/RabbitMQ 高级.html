<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ 高级 | Chiriri</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/doc-vuepress/favicon.ico">
    <meta name="description" content="Chiriridesu">
    
    <link rel="preload" href="/doc-vuepress/assets/css/0.styles.f3cbd881.css" as="style"><link rel="preload" href="/doc-vuepress/assets/js/app.d9f058a2.js" as="script"><link rel="preload" href="/doc-vuepress/assets/js/2.3b3db5cf.js" as="script"><link rel="preload" href="/doc-vuepress/assets/js/55.c593a0bd.js" as="script"><link rel="prefetch" href="/doc-vuepress/assets/js/10.b164b477.js"><link rel="prefetch" href="/doc-vuepress/assets/js/100.9586193b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/101.fbfb8023.js"><link rel="prefetch" href="/doc-vuepress/assets/js/102.35211624.js"><link rel="prefetch" href="/doc-vuepress/assets/js/103.a852832b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/104.d3840a25.js"><link rel="prefetch" href="/doc-vuepress/assets/js/105.bb97f57b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/106.f1ce2ff3.js"><link rel="prefetch" href="/doc-vuepress/assets/js/107.bcc1af18.js"><link rel="prefetch" href="/doc-vuepress/assets/js/108.aea72a13.js"><link rel="prefetch" href="/doc-vuepress/assets/js/109.ea26c2b6.js"><link rel="prefetch" href="/doc-vuepress/assets/js/11.0cc7b3fe.js"><link rel="prefetch" href="/doc-vuepress/assets/js/110.1dbc43ae.js"><link rel="prefetch" href="/doc-vuepress/assets/js/111.6c704305.js"><link rel="prefetch" href="/doc-vuepress/assets/js/112.2104312f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/113.3af2e44c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/114.83fa7f12.js"><link rel="prefetch" href="/doc-vuepress/assets/js/115.03b9877c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/116.94139d50.js"><link rel="prefetch" href="/doc-vuepress/assets/js/117.d6922e84.js"><link rel="prefetch" href="/doc-vuepress/assets/js/118.d6600176.js"><link rel="prefetch" href="/doc-vuepress/assets/js/119.6e2fc19d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/12.42e85628.js"><link rel="prefetch" href="/doc-vuepress/assets/js/120.fb904b71.js"><link rel="prefetch" href="/doc-vuepress/assets/js/121.e5418133.js"><link rel="prefetch" href="/doc-vuepress/assets/js/122.23684851.js"><link rel="prefetch" href="/doc-vuepress/assets/js/123.a2201e8f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/124.5398a4db.js"><link rel="prefetch" href="/doc-vuepress/assets/js/125.acf77852.js"><link rel="prefetch" href="/doc-vuepress/assets/js/126.8cc2a7ef.js"><link rel="prefetch" href="/doc-vuepress/assets/js/127.636078e5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/128.3dda16ec.js"><link rel="prefetch" href="/doc-vuepress/assets/js/129.76fb4160.js"><link rel="prefetch" href="/doc-vuepress/assets/js/13.22626cf9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/130.4050b596.js"><link rel="prefetch" href="/doc-vuepress/assets/js/131.dcf83479.js"><link rel="prefetch" href="/doc-vuepress/assets/js/132.34df2699.js"><link rel="prefetch" href="/doc-vuepress/assets/js/133.0c2f2395.js"><link rel="prefetch" href="/doc-vuepress/assets/js/134.631acf38.js"><link rel="prefetch" href="/doc-vuepress/assets/js/135.3c7a8002.js"><link rel="prefetch" href="/doc-vuepress/assets/js/136.9d498fad.js"><link rel="prefetch" href="/doc-vuepress/assets/js/137.52b3491f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/138.2def15df.js"><link rel="prefetch" href="/doc-vuepress/assets/js/139.2027a741.js"><link rel="prefetch" href="/doc-vuepress/assets/js/14.a0e74d71.js"><link rel="prefetch" href="/doc-vuepress/assets/js/140.14025373.js"><link rel="prefetch" href="/doc-vuepress/assets/js/141.3be2fa6f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/142.7a2f26a6.js"><link rel="prefetch" href="/doc-vuepress/assets/js/143.2226636a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/144.d6cb4516.js"><link rel="prefetch" href="/doc-vuepress/assets/js/145.cb3d04a4.js"><link rel="prefetch" href="/doc-vuepress/assets/js/146.c2363b65.js"><link rel="prefetch" href="/doc-vuepress/assets/js/147.2d96c979.js"><link rel="prefetch" href="/doc-vuepress/assets/js/148.1932e886.js"><link rel="prefetch" href="/doc-vuepress/assets/js/149.2bb44329.js"><link rel="prefetch" href="/doc-vuepress/assets/js/15.487511b9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/150.54f16e16.js"><link rel="prefetch" href="/doc-vuepress/assets/js/151.1ccddd4a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/152.c2aae540.js"><link rel="prefetch" href="/doc-vuepress/assets/js/153.818ba26e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/154.4083fc73.js"><link rel="prefetch" href="/doc-vuepress/assets/js/155.fcb284df.js"><link rel="prefetch" href="/doc-vuepress/assets/js/156.2d9dd10c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/157.2d97df21.js"><link rel="prefetch" href="/doc-vuepress/assets/js/158.b933259f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/159.127ec2ce.js"><link rel="prefetch" href="/doc-vuepress/assets/js/16.99912d5c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/160.7a9466de.js"><link rel="prefetch" href="/doc-vuepress/assets/js/161.a0965a1e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/162.9ba63ff6.js"><link rel="prefetch" href="/doc-vuepress/assets/js/163.113f0d78.js"><link rel="prefetch" href="/doc-vuepress/assets/js/164.77e0c395.js"><link rel="prefetch" href="/doc-vuepress/assets/js/165.d4f26c88.js"><link rel="prefetch" href="/doc-vuepress/assets/js/166.a4a8a100.js"><link rel="prefetch" href="/doc-vuepress/assets/js/167.f1a4e055.js"><link rel="prefetch" href="/doc-vuepress/assets/js/168.28bca86c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/169.b99892fc.js"><link rel="prefetch" href="/doc-vuepress/assets/js/17.31966cc8.js"><link rel="prefetch" href="/doc-vuepress/assets/js/170.0d63cca0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/171.150d95f7.js"><link rel="prefetch" href="/doc-vuepress/assets/js/172.82820234.js"><link rel="prefetch" href="/doc-vuepress/assets/js/173.d8cdd9b8.js"><link rel="prefetch" href="/doc-vuepress/assets/js/174.cc3e8688.js"><link rel="prefetch" href="/doc-vuepress/assets/js/175.c85fb692.js"><link rel="prefetch" href="/doc-vuepress/assets/js/176.a9864030.js"><link rel="prefetch" href="/doc-vuepress/assets/js/177.01f901aa.js"><link rel="prefetch" href="/doc-vuepress/assets/js/178.d4d7719a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/179.8e5df995.js"><link rel="prefetch" href="/doc-vuepress/assets/js/18.487740e0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/180.c283ed3a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/181.4d553ce8.js"><link rel="prefetch" href="/doc-vuepress/assets/js/182.5f1d0255.js"><link rel="prefetch" href="/doc-vuepress/assets/js/183.bdbabf31.js"><link rel="prefetch" href="/doc-vuepress/assets/js/184.cd3a123a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/185.4f0aed34.js"><link rel="prefetch" href="/doc-vuepress/assets/js/186.1c7423c5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/187.a3260f92.js"><link rel="prefetch" href="/doc-vuepress/assets/js/188.b2b395d2.js"><link rel="prefetch" href="/doc-vuepress/assets/js/189.c3e16d42.js"><link rel="prefetch" href="/doc-vuepress/assets/js/19.a5a43fa0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/190.0027611b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/191.5da79366.js"><link rel="prefetch" href="/doc-vuepress/assets/js/192.de572ba5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/193.e7eecd76.js"><link rel="prefetch" href="/doc-vuepress/assets/js/194.c0c9a3e1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/195.4c9e640a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/196.bca887a2.js"><link rel="prefetch" href="/doc-vuepress/assets/js/197.32b3ef9a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/198.36dd1121.js"><link rel="prefetch" href="/doc-vuepress/assets/js/199.a7a2ea66.js"><link rel="prefetch" href="/doc-vuepress/assets/js/20.f16a556e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/200.541d2d45.js"><link rel="prefetch" href="/doc-vuepress/assets/js/201.2a6bc31e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/202.1ab0ebf7.js"><link rel="prefetch" href="/doc-vuepress/assets/js/203.8ea83886.js"><link rel="prefetch" href="/doc-vuepress/assets/js/204.71960433.js"><link rel="prefetch" href="/doc-vuepress/assets/js/205.face6c2c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/206.edb32265.js"><link rel="prefetch" href="/doc-vuepress/assets/js/207.7edd2587.js"><link rel="prefetch" href="/doc-vuepress/assets/js/208.8eb4dd8a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/209.1e71f98c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/21.80c27c79.js"><link rel="prefetch" href="/doc-vuepress/assets/js/210.d0362700.js"><link rel="prefetch" href="/doc-vuepress/assets/js/211.ad68c64c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/212.8b718048.js"><link rel="prefetch" href="/doc-vuepress/assets/js/213.4ba985f2.js"><link rel="prefetch" href="/doc-vuepress/assets/js/214.07f64a1f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/215.daee3c3e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/216.32992c2f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/217.7529cd64.js"><link rel="prefetch" href="/doc-vuepress/assets/js/218.0ca3a67d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/219.e61a2c40.js"><link rel="prefetch" href="/doc-vuepress/assets/js/22.c30ea85f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/220.251d745a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/221.1d95ee5c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/222.4a52a281.js"><link rel="prefetch" href="/doc-vuepress/assets/js/223.5647c4eb.js"><link rel="prefetch" href="/doc-vuepress/assets/js/224.e27da076.js"><link rel="prefetch" href="/doc-vuepress/assets/js/225.896a2b7e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/226.9269748b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/227.f7fc3384.js"><link rel="prefetch" href="/doc-vuepress/assets/js/228.3c17af77.js"><link rel="prefetch" href="/doc-vuepress/assets/js/23.b160b248.js"><link rel="prefetch" href="/doc-vuepress/assets/js/24.52ffcd3c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/25.0038c555.js"><link rel="prefetch" href="/doc-vuepress/assets/js/26.c1d32d66.js"><link rel="prefetch" href="/doc-vuepress/assets/js/27.361aa74e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/28.301d1f1b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/29.db696a70.js"><link rel="prefetch" href="/doc-vuepress/assets/js/3.618cc386.js"><link rel="prefetch" href="/doc-vuepress/assets/js/30.82c215a1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/31.4218ee88.js"><link rel="prefetch" href="/doc-vuepress/assets/js/32.185a0605.js"><link rel="prefetch" href="/doc-vuepress/assets/js/33.8e56a2c2.js"><link rel="prefetch" href="/doc-vuepress/assets/js/34.e93b30c8.js"><link rel="prefetch" href="/doc-vuepress/assets/js/35.c029905f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/36.3c26314a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/37.281e9bbf.js"><link rel="prefetch" href="/doc-vuepress/assets/js/38.95142af3.js"><link rel="prefetch" href="/doc-vuepress/assets/js/39.7b46210b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/4.ab196059.js"><link rel="prefetch" href="/doc-vuepress/assets/js/40.da793450.js"><link rel="prefetch" href="/doc-vuepress/assets/js/41.ae5d114c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/42.6092d6fd.js"><link rel="prefetch" href="/doc-vuepress/assets/js/43.3676ecec.js"><link rel="prefetch" href="/doc-vuepress/assets/js/44.604dee90.js"><link rel="prefetch" href="/doc-vuepress/assets/js/45.ef7b2563.js"><link rel="prefetch" href="/doc-vuepress/assets/js/46.5126b263.js"><link rel="prefetch" href="/doc-vuepress/assets/js/47.15c9fa2f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/48.4d000b30.js"><link rel="prefetch" href="/doc-vuepress/assets/js/49.c04122ec.js"><link rel="prefetch" href="/doc-vuepress/assets/js/5.61dedc87.js"><link rel="prefetch" href="/doc-vuepress/assets/js/50.b36b2268.js"><link rel="prefetch" href="/doc-vuepress/assets/js/51.38b2e042.js"><link rel="prefetch" href="/doc-vuepress/assets/js/52.fa2688bf.js"><link rel="prefetch" href="/doc-vuepress/assets/js/53.8e7b4e2a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/54.cc60f637.js"><link rel="prefetch" href="/doc-vuepress/assets/js/56.b92ff64e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/57.0127b901.js"><link rel="prefetch" href="/doc-vuepress/assets/js/58.b51e39e7.js"><link rel="prefetch" href="/doc-vuepress/assets/js/59.4656872e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/6.7862f44a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/60.0b84f136.js"><link rel="prefetch" href="/doc-vuepress/assets/js/61.77bb1c42.js"><link rel="prefetch" href="/doc-vuepress/assets/js/62.255b2396.js"><link rel="prefetch" href="/doc-vuepress/assets/js/63.0784c59f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/64.bfd10989.js"><link rel="prefetch" href="/doc-vuepress/assets/js/65.271e0fe0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/66.37d35e9b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/67.1f723e6e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/68.1d6b4d62.js"><link rel="prefetch" href="/doc-vuepress/assets/js/69.751866f7.js"><link rel="prefetch" href="/doc-vuepress/assets/js/7.16153ad4.js"><link rel="prefetch" href="/doc-vuepress/assets/js/70.5a176ed9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/71.cefafd88.js"><link rel="prefetch" href="/doc-vuepress/assets/js/72.89cf0ee7.js"><link rel="prefetch" href="/doc-vuepress/assets/js/73.7ae1caa5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/74.3a0426c5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/75.346a5b12.js"><link rel="prefetch" href="/doc-vuepress/assets/js/76.40d6b949.js"><link rel="prefetch" href="/doc-vuepress/assets/js/77.af42e53e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/78.a1a1041d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/79.3979b3e2.js"><link rel="prefetch" href="/doc-vuepress/assets/js/8.51f8b48e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/80.ddedd06c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/81.f47899f4.js"><link rel="prefetch" href="/doc-vuepress/assets/js/82.b64b79c5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/83.3d3b0dd8.js"><link rel="prefetch" href="/doc-vuepress/assets/js/84.f20ba61e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/85.3a85fe1a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/86.a2c68016.js"><link rel="prefetch" href="/doc-vuepress/assets/js/87.e498e9cf.js"><link rel="prefetch" href="/doc-vuepress/assets/js/88.16da169b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/89.dfdd9486.js"><link rel="prefetch" href="/doc-vuepress/assets/js/9.b89c29c6.js"><link rel="prefetch" href="/doc-vuepress/assets/js/90.9dfc4480.js"><link rel="prefetch" href="/doc-vuepress/assets/js/91.29fae888.js"><link rel="prefetch" href="/doc-vuepress/assets/js/92.3a2f5266.js"><link rel="prefetch" href="/doc-vuepress/assets/js/93.2a30db4b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/94.d73d493b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/95.4675d725.js"><link rel="prefetch" href="/doc-vuepress/assets/js/96.ba849b11.js"><link rel="prefetch" href="/doc-vuepress/assets/js/97.167b1f35.js"><link rel="prefetch" href="/doc-vuepress/assets/js/98.cd43851a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/99.6b57d9c5.js">
    <link rel="stylesheet" href="/doc-vuepress/assets/css/0.styles.f3cbd881.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/doc-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">Chiriri</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/doc-vuepress/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/JavaSE/" class="nav-link">
  JavaSE
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/JavaEE/" class="nav-link router-link-active">
  JavaEE
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/SQL/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/机器学习/" class="nav-link">
  机器学习
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Python模块/" class="nav-link">
  Python模块
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/Hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Flume/" class="nav-link">
  Flume
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Kafka/" class="nav-link">
  Kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/前端/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Vue/" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/doc-vuepress/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/JavaSE/" class="nav-link">
  JavaSE
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/JavaEE/" class="nav-link router-link-active">
  JavaEE
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/SQL/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/机器学习/" class="nav-link">
  机器学习
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Python模块/" class="nav-link">
  Python模块
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/Hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Flume/" class="nav-link">
  Flume
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Kafka/" class="nav-link">
  Kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/前端/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Vue/" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/doc-vuepress/JavaEE/JDBC.html" class="sidebar-link">JDBC</a></li><li><a href="/doc-vuepress/JavaEE/MyBatis.html" class="sidebar-link">MyBatis</a></li><li><a href="/doc-vuepress/JavaEE/Jackson.html" class="sidebar-link">Jackson</a></li><li><a href="/doc-vuepress/JavaEE/Jedis.html" class="sidebar-link">Jedis</a></li><li><a href="/doc-vuepress/JavaEE/Maven.html" class="sidebar-link">Maven</a></li><li><a href="/doc-vuepress/JavaEE/POI.html" class="sidebar-link">POI</a></li><li><a href="/doc-vuepress/JavaEE/Spring.html" class="sidebar-link">Spring</a></li><li><a href="/doc-vuepress/JavaEE/SpringMVC.html" class="sidebar-link">Spring MVC</a></li><li><a href="/doc-vuepress/JavaEE/Maven高级.html" class="sidebar-link">Maven 高级</a></li><li><a href="/doc-vuepress/JavaEE/Dubbo.html" class="sidebar-link">Dubbo</a></li><li><a href="/doc-vuepress/JavaEE/Zookeeper.html" class="sidebar-link">Zookeeper</a></li><li><a href="/doc-vuepress/JavaEE/SpringSecurity.html" class="sidebar-link">Spring Security</a></li><li><a href="/doc-vuepress/JavaEE/SpringBoot.html" class="sidebar-link">Spring Boot</a></li><li><a href="/doc-vuepress/JavaEE/SpringBoot高级.html" class="sidebar-link">Spring Boot 高级</a></li><li><a href="/doc-vuepress/JavaEE/RabbitMQ.html" class="sidebar-link">RabbitMQ</a></li><li><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html" class="active sidebar-link">RabbitMQ 高级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#消息的可靠投递-生产端" class="sidebar-link">消息的可靠投递(生产端)</a></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#consumer-ack-消费端" class="sidebar-link">Consumer Ack(消费端)</a></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#消费端限流-消费端" class="sidebar-link">消费端限流(消费端)</a></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#ttl-生产端" class="sidebar-link">TTL(生产端)</a></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#死信队列" class="sidebar-link">死信队列</a></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#延迟队列" class="sidebar-link">延迟队列</a></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#日志监控" class="sidebar-link">日志监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#消息追踪" class="sidebar-link">消息追踪</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#消息补偿" class="sidebar-link">消息补偿</a></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#消息幂等性保障" class="sidebar-link">消息幂等性保障</a></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#集群搭建" class="sidebar-link">集群搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#镜像队列" class="sidebar-link">镜像队列</a></li><li class="sidebar-sub-header"><a href="/doc-vuepress/JavaEE/RabbitMQ 高级.html#负载均衡-haproxy" class="sidebar-link">负载均衡-HAProxy</a></li></ul></li></ul></li><li><a href="/doc-vuepress/JavaEE/Spring Cloud.html" class="sidebar-link">Spring Cloud</a></li><li><a href="/doc-vuepress/JavaEE/Docker.html" class="sidebar-link">Docker</a></li><li><a href="/doc-vuepress/JavaEE/ElasticSearch.html" class="sidebar-link">ElasticSearch</a></li><li><a href="/doc-vuepress/JavaEE/ElasticSearch 高级.html" class="sidebar-link">ElasticSearch 高级</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rabbitmq-高级"><a href="#rabbitmq-高级" class="header-anchor">#</a> RabbitMQ 高级</h1> <h2 id="消息的可靠投递-生产端"><a href="#消息的可靠投递-生产端" class="header-anchor">#</a> 消息的可靠投递(生产端)</h2> <p>RabbitMQ为我们提供了两种方式用来控制消息的投递可靠性模式</p> <ul><li>confirm 确认模式  已经过时</li> <li>return 退回模式</li></ul> <p>rabbitmq 整个消息投递路径为</p> <p>producer ---&gt;  rabbitmq broker --&gt; exchange  ---&gt;  queue --&gt; consumer</p> <ul><li>消息从 producer 到 exchange 则会返回一个 confirmCallback</li> <li>消息从 exchange --&gt; queue 投递失败则会返回一个 returnCallback</li></ul> <p>利用这两个callback控制消息的可靠性投递</p> <p>rabbitmq配置文件</p> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token comment">&lt;!--    加载配置文件--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:rabbitmq.properties<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--    定义rabbitmq connectionFactory--&gt;</span>
    <span class="token comment">&lt;!--  returns开启回退模式设置为 publisher-returns=&quot;true&quot; --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>connection-factory</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>connectionFactory<span class="token punctuation">&quot;</span></span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${rabbitmq.host}<span class="token punctuation">&quot;</span></span>
                               <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${rabbitmq.port}<span class="token punctuation">&quot;</span></span>
                               <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${rabbitmq.username}<span class="token punctuation">&quot;</span></span>
                               <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${rabbitmq.password}<span class="token punctuation">&quot;</span></span>
                               <span class="token attr-name">virtual-host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${rabbitmq.virtual-host}<span class="token punctuation">&quot;</span></span>
                               <span class="token attr-name">publisher-returns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span>

    <span class="token punctuation">/&gt;</span></span>
<span class="token comment">&lt;!-- 消息可靠性投递(生产端) --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_queue_confirm<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_queue_confirm<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>direct-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_exchange_confirm<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_queue_confirm<span class="token punctuation">&quot;</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>confirm<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>direct-exchange</span><span class="token punctuation">&gt;</span></span>


    <span class="token comment">&lt;!--    定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rabbitTemplate<span class="token punctuation">&quot;</span></span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>connectionFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

</code></pre></div><p>test</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/*
    回退模式 :当消息发送给Exchange后,Exchange路由到Queue失败是 才会执行 ReturnCallBack
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token comment">//设置交换机处理失败消息的模式 必须开启之后 失败发送失败才会回调</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置returncallback</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnsCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnsCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">returnedMessage</span><span class="token punctuation">(</span><span class="token class-name">ReturnedMessage</span> returnedMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;return 执行了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>returnedMessage<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//消息对象</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>returnedMessage<span class="token punctuation">.</span><span class="token function">getReplyCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//错误码</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>returnedMessage<span class="token punctuation">.</span><span class="token function">getReplyText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//错误信息</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>returnedMessage<span class="token punctuation">.</span><span class="token function">getExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//交换机</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>returnedMessage<span class="token punctuation">.</span><span class="token function">getRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//路由键</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//给不存在频道中的key发送消息 </span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;test_exchange_confirm&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;confirm111&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello callback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre></div><h2 id="consumer-ack-消费端"><a href="#consumer-ack-消费端" class="header-anchor">#</a> Consumer Ack(消费端)</h2> <p>ack指 Acknowledge 确认 表示消费端收到消息后的确认方式</p> <p>有三种确认方式</p> <ul><li>默认为自动确认 acknowledge=&quot;none&quot;</li> <li>手动确认 acknowledge=&quot;manual&quot;</li> <li>根据异常情况确认  acknowledge=&quot;auto&quot;</li></ul> <p>rabbitmq配置文件  <strong>消费端</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token comment">&lt;!--spring扫描监听器类    --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.itheima.listener<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>    <span class="token comment">&lt;!--    定义监听器容器--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener-container</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>connectionFactory<span class="token punctuation">&quot;</span></span> <span class="token attr-name">acknowledge</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>manual<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ackListener<span class="token punctuation">&quot;</span></span> <span class="token attr-name">queue-names</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_queue_confirm<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>listener-container</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>监听类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">ChannelAwareMessageListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Consumer ACK机制
 * 设置手动签收 acknowledge=&quot;manual&quot;
 * 让监听器类实现 ChannelAwareMessageListener 接口 实现 onMessage方法
 */</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AckListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//接受信息</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//业务逻辑</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//手动签收</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//            e.printStackTrace();</span>
            <span class="token comment">//拒绝签收  basicNack允许多条消息 第三个参数requeue     设置为true则重新回到队列中</span>
            channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            channel.basicReject(deliveryTag, true);</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre></div><h2 id="消费端限流-消费端"><a href="#消费端限流-消费端" class="header-anchor">#</a> 消费端限流(消费端)</h2> <p>rabbitmq配置文件</p> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token comment">&lt;!--spring扫描监听器类    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.itheima.listener<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--    定义监听器容器--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener-container</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>connectionFactory<span class="token punctuation">&quot;</span></span> <span class="token attr-name">acknowledge</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>manual<span class="token punctuation">&quot;</span></span> <span class="token attr-name">prefetch</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--        &lt;rabbit:listener ref=&quot;ackListener&quot; queue-names=&quot;test_queue_confirm&quot; /&gt;--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>qosListener<span class="token punctuation">&quot;</span></span> <span class="token attr-name">queue-names</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_queue_confirm<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>listener-container</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>限流监听类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">ChannelAwareMessageListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 限流机制
 * acr机制设置为手动确认
 * listener-container配置属性 perfetch = 1  表示消费端每次从mq拉取一条消息  直到手动确认消费完毕后才去拉取下一条消息
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QosListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取消息</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//处理业务逻辑</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;业务逻辑&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//签收  直到手动确认消费完毕后才去拉取下一条消息</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ttl-生产端"><a href="#ttl-生产端" class="header-anchor">#</a> TTL(生产端)</h2> <p>TTL 为存活时间 / 过期时间</p> <p>当消息到达存活时间后 还没有被消费 会被自动清除</p> <p>RabbitMQ可以对消息设置过期时间 也可以对整个队列设置过期时间</p> <p>生产端配置文件</p> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token comment">&lt;!--    ttl--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_spring_queue_ttl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-message-ttl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>long<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_exchange_ttl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ttl.#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_spring_queue_ttl<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>test发送消息</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Testpublic</span> <span class="token keyword">void</span> <span class="token function">testTtl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//ttl发送消息    rabbitTemplate.convertAndSend(&quot;test_exchange_ttl&quot;, &quot;ttl.eee&quot;, &quot;hello ttl&quot;, new MessagePostProcessor() {        //消息后处理对象 设置一些消息的参数信息        @Override        public Message postProcessMessage(Message message) throws AmqpException {            //1.设置message的消息            message.getMessageProperties().setExpiration(&quot;5000&quot;);//消息的过期时间 毫秒            return message;  //如果设置了队列过期时间和消息的过期时间 则以时间短的为准            //队列过期后会将该队列的所有消息清空            //消息过期后.只有消息在队列顶端,才会判断其是否过期        }    });}</span>
</code></pre></div><h2 id="死信队列"><a href="#死信队列" class="header-anchor">#</a> 死信队列</h2> <p>DLX(Dead Letter Exchange) 死信交换机  当消息成为 Dead message后可以被重新发送到另外一台交换机 那么这个交换机就是DLX</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211001063755240.png" alt="image-20211001063755240"></p> <p>消息成为死信的情况</p> <ol><li>队列消息长度到达限制</li> <li>消费者拒接消费消息,basicNack/basicReject 并且不把消息重新放入原目标队列.requeue=false</li> <li>原队列存在消费过期设置 消息到达超时时间未被消费</li></ol> <p>定义正常队列和死信队列</p> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token comment">&lt;!--    死信队列 --&gt;</span>
    <span class="token comment">&lt;!--     1.声明正常的队列(test_queue_dlx)和交换机(test_exchange_dlx)--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_queue_dlx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_queue_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--            3.正常队列绑定死信交换机--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--         - x-dead-letter-exchange:死信交换机名称--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-dead-letter-exchange<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>exchange_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!--                    - x-dead-letter-routing-key 死信交换机的routingkey--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-dead-letter-routing-key<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dlx.hehe<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!--        设置队列过期时间--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-message-ttl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5000<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java.lang.Integer<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!--        设置队列长度--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-max-length<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java.lang.Integer<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_exchange_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test.dlx.#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_queue_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--    2.声明死信的队列(queue.dlx)和交换机(exchange_dxl)--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>queue_dlx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>queue_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>exchange_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dlx.#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>queue_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>test</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDlx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//1.测试过期时间//        rabbitTemplate.convertAndSend(&quot;test_exchange_dlx&quot;, &quot;test.dlx.haha&quot;, &quot;dlx&quot;);        //2.超过队列长度  消息死信//        for (int i = 0; i &lt; 20; i++) {//            rabbitTemplate.convertAndSend(&quot;test_exchange_dlx&quot;, &quot;test.dlx.haha&quot;, &quot;dlx&quot; + i);//        }        //3.消费者拒接签收消息 并设置不重回队列中        rabbitTemplate.convertAndSend(&quot;test_exchange_dlx&quot;, &quot;test.dlx.haha&quot;, &quot;dlx&quot;);    }</span>
</code></pre></div><p>消费者拒接签收消息 监听配置</p> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.itheima.listener<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span><span class="token comment">&lt;!--    定义监听器容器--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener-container</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>connectionFactory<span class="token punctuation">&quot;</span></span> <span class="token attr-name">acknowledge</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>manual<span class="token punctuation">&quot;</span></span> <span class="token attr-name">prefetch</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!--        &lt;rabbit:listener ref=&quot;ackListener&quot; queue-names=&quot;test_queue_confirm&quot; /&gt;--&gt;</span>        <span class="token comment">&lt;!--        &lt;rabbit:listener ref=&quot;qosListener&quot; queue-names=&quot;test_queue_confirm&quot; /&gt;--&gt;</span>        <span class="token comment">&lt;!--        监听正常的队列--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dlxListener<span class="token punctuation">&quot;</span></span> <span class="token attr-name">queue-names</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test_queue_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>listener-container</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>监听类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">ChannelAwareMessageListener</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Componentpublic</span> <span class="token keyword">class</span> <span class="token class-name">DlxListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment">//接受信息            System.out.println(new String(message.getBody()));            //业务逻辑            System.out.println(&quot;处理&quot;);            int i = 3 / 0;// 出现异常            //手动签收            channel.basicAck(deliveryTag, true);        } catch (Exception e) {//            e.printStackTrace();            System.out.println(&quot;拒绝签收&quot;);            //拒绝签收  basicNack允许多条消息 第三个参数requeue     设置为true则重新回到队列中 此处是死信队列所以我们不重回队列中            channel.basicNack(deliveryTag, true, false);//            channel.basicReject(deliveryTag, true);        }    }}</span>
</code></pre></div><h2 id="延迟队列"><a href="#延迟队列" class="header-anchor">#</a> 延迟队列</h2> <p>延迟队列 即消息进入队列后不会立即被消费 只有到达指定时间后 才会被消费</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211001153454330.png" alt="image-20211001153454330"></p> <p>rabbitmq中并没有提供延迟队列功能 但是我们可以通过使用 TTL+死信队列 组合实现延迟队列的效果</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211001153641730.png" alt="image-20211001153641730"></p> <ol><li>定义正常队列和死信队列  并且设置TTL过去时间</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--    延迟队列 通过TTL+死信队列实现--&gt;</span>
<span class="token comment">&lt;!--    定义正常队列 和交换机--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_queue<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_queue<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--        绑定死信队列 和设置TTL过期时间--&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-dead-letter-exchange<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_exchange_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-dead-letter-routing-key<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dlx.order.cancel<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-message-ttl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5000<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java.lang.Integer<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_exchange<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order.#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_queue<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--    死信队列--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_queue_dlx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_queue_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_exchange_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dlx.order.#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_queue_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>发送消息</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">testDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order_exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.msg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;延迟队列&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>监听配置</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--spring扫描监听器类    --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.itheima.listener<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span><span class="token comment">&lt;!--    定义监听器容器--&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener-container</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>connectionFactory<span class="token punctuation">&quot;</span></span> <span class="token attr-name">acknowledge</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>manual<span class="token punctuation">&quot;</span></span> <span class="token attr-name">prefetch</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!--        &lt;rabbit:listener ref=&quot;ackListener&quot; queue-names=&quot;test_queue_confirm&quot; /&gt;--&gt;</span>    <span class="token comment">&lt;!--        &lt;rabbit:listener ref=&quot;qosListener&quot; queue-names=&quot;test_queue_confirm&quot; /&gt;--&gt;</span>    <span class="token comment">&lt;!--        监听正常的队列--&gt;</span>    <span class="token comment">&lt;!--        &lt;rabbit:listener ref=&quot;dlxListener&quot; queue-names=&quot;test_queue_dlx&quot;/&gt;--&gt;</span>    <span class="token comment">&lt;!--        延迟队列  监听的是TTL过期后的死信队列--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>orderListener<span class="token punctuation">&quot;</span></span> <span class="token attr-name">queue-names</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>order_queue_dlx<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>listener-container</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="4"><li>监听类</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">ChannelAwareMessageListener</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Componentpublic</span> <span class="token keyword">class</span> <span class="token class-name">OrderListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment">//接受信息            System.out.println(new String(message.getBody()));            //业务逻辑            System.out.println(&quot;业务 处理&quot;);            //手动签收            channel.basicAck(deliveryTag, true);        } catch (IOException e) {//            e.printStackTrace();            //拒绝签收  basicNack允许多条消息 第三个参数requeue     设置为true则重新回到队列中            channel.basicNack(deliveryTag, true, true);//            channel.basicReject(deliveryTag, true);        }    }</span>
</code></pre></div><h2 id="日志监控"><a href="#日志监控" class="header-anchor">#</a> 日志监控</h2> <p>RabbitMQ默认日志存放路径 /var/log/rabbitmq/rabbit@xxx.log</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211001164637161.png" alt="image-20211001164637161"></p> <h3 id="消息追踪"><a href="#消息追踪" class="header-anchor">#</a> 消息追踪</h3> <p>开启firehose后 默认路由会将消息重新发送一遍 并且包含消息从哪里传递等具体信息打包过去队列中</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211001165325603.png" alt="image-20211001165325603"></p> <p>网页插件版</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211001165757447.png" alt="image-20211001165757447"></p> <h2 id="消息补偿"><a href="#消息补偿" class="header-anchor">#</a> 消息补偿</h2> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211001170157293.png" alt="image-20211001170157293"></p> <h2 id="消息幂等性保障"><a href="#消息幂等性保障" class="header-anchor">#</a> 消息幂等性保障</h2> <p>幂等性指一次和多次请求某一个资源,对于资源本身应该具有同样的结果 也就是说其 任意多次执行对资源所产生的影响与一次执行的影响相同</p> <p>在MQ中指 消费多条相同的消息 与消费一条消息得到结果一致</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211001170702968.png" alt="image-20211001170702968"></p> <h2 id="集群搭建"><a href="#集群搭建" class="header-anchor">#</a> 集群搭建</h2> <p>停止rabbitmq服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rabbitmqctl stop
</code></pre></div><p>启动第一个节点 此处是单机器 多端口搭建伪集群   集群用ip区分即可</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">RABBITMQ_NODE_PORT</span><span class="token operator">=</span><span class="token number">5673</span> <span class="token assign-left variable">RABBITMQ_NODENAME</span><span class="token operator">=</span>rabbit1 rabbitmq-server start
</code></pre></div><p>启动第二个节点 因为默认web插件端口被占用所以也要设置web插口端口</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">RABBITMQ_NODE_PORT</span><span class="token operator">=</span><span class="token number">5674</span> <span class="token assign-left variable">RABBITMQ_SERVER_START_ARGS</span><span class="token operator">=</span><span class="token string">&quot;-rabbitmq_management listener [{port,15674}]&quot;</span> <span class="token assign-left variable">RABBITMQ_NODENAME</span><span class="token operator">=</span>rabbit2 rabbitmq-server start
</code></pre></div><p>设置rabbit1为主节点</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rabbitmqctl -n rabbit1 stop_apprabbitmqctl -n rabbit1 resetrabbitmqctl -n rabbit1 start_app
</code></pre></div><p>设置rabbit2为从节点</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rabbitmqctl -n rabbit2 stop_apprabbitmqctl -n rabbit2 resetrabbitmqctl -n rabbit2 join_cluster rabbit1@<span class="token string">'dubbo'</span>  <span class="token comment">#@''后面为系统用户名 需要自己更改rabbitmqctl -n rabbit2 start_app</span>
</code></pre></div><h3 id="镜像队列"><a href="#镜像队列" class="header-anchor">#</a> 镜像队列</h3> <p>从节点默认是从主节点中获取数据 我们可以通过镜像队列来将每个节点同存放想相同数据</p> <p>命令方式</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rabbitmqctl set_policy my_ha <span class="token string">&quot;^&quot;</span><span class="token string">'{&quot;ha-mode&quot;:&quot;all&quot;}'</span>
</code></pre></div><p>网页方式</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211001180810034.png" alt="image-20211001180810034"></p> <h3 id="负载均衡-haproxy"><a href="#负载均衡-haproxy" class="header-anchor">#</a> 负载均衡-HAProxy</h3> <p>https://blog.csdn.net/William0318/article/details/99677701</p> <p>安装</p> <div class="language-sh extra-class"><pre class="language-sh"><code>yum <span class="token function">install</span> haproxy -yhaproxy -v
</code></pre></div><p>配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> /etc/haproxy/haproxy.cfg
</code></pre></div><p>编辑内容</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#全局配置</span>
global
    <span class="token comment">#设置日志</span>
    log <span class="token number">127.0</span>.0.1 local0 info
    <span class="token comment">#当前工作目录</span>
    <span class="token function">chroot</span> /usr/local/haproxy
    <span class="token comment">#用户与用户组</span>
    user haproxy
    group haproxy
    <span class="token comment">#运行进程ID</span>
    uid <span class="token number">99</span>
    gid <span class="token number">99</span>
    <span class="token comment">#守护进程启动</span>
    daemon
    <span class="token comment">#最大连接数</span>
    maxconn <span class="token number">4096</span>
<span class="token comment">#默认配置</span>
defaults
    <span class="token comment">#应用全局的日志配置</span>
    log global
    <span class="token comment">#默认的模式mode {tcp|http|health}</span>
    <span class="token comment">#TCP是4层，HTTP是7层，health只返回OK</span>
    mode tcp
    <span class="token comment">#日志类别tcplog</span>
    option tcplog
    <span class="token comment">#不记录健康检查日志信息</span>
    option dontlognull
    <span class="token comment">#3次失败则认为服务不可用</span>
    retries <span class="token number">3</span>
    <span class="token comment">#每个进程可用的最大连接数</span>
    maxconn <span class="token number">2000</span>
    <span class="token comment">#连接超时</span>
    <span class="token function">timeout</span> connect 5s
    <span class="token comment">#客户端超时</span>
    <span class="token function">timeout</span> client 120s
    <span class="token comment">#服务端超时</span>
    <span class="token function">timeout</span> server 120s
<span class="token comment">#绑定配置</span>
listen rabbitmq_cluster 
        <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:5672
        <span class="token comment">#配置TCP模式</span>
        mode tcp
        <span class="token comment">#简单的轮询</span>
        balance roundrobin
        <span class="token comment">#RabbitMQ集群节点配置</span>
        server rmq_node1 <span class="token number">127.0</span>.0.1:5673 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">3</span> weight <span class="token number">1</span>
        server rmq_node2 <span class="token number">127.0</span>.0.1:5674 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">3</span> weight <span class="token number">1</span>
<span class="token comment">#haproxy监控页面地址</span>
listen monitor 
        <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:8100
        mode http
        option httplog
        stats <span class="token builtin class-name">enable</span>
        stats uri /stats
        stats refresh 5s
</code></pre></div><p>检查配置文件是否错误</p> <div class="language-sh extra-class"><pre class="language-sh"><code>haproxy -f /etc/haproxy/haproxy.cfg -c
</code></pre></div><p>启动</p> <div class="language-sh extra-class"><pre class="language-sh"><code>haproxy -f /etc/haproxy/haproxy.cfg -d
</code></pre></div><p>访问HAProxy后台</p> <p>http://192.168.130.124:8100/stats</p> <p>后续将消息队列的地址和ip设置为HAProxy监听的地址即可</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment">#消息队列配置</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.0.104 <span class="token comment">#HAProxy的地址</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /
    <span class="token key atrule">publisher-returns</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">publisher-confirms</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">connection-timeout</span><span class="token punctuation">:</span> 5000ms
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/doc-vuepress/JavaEE/RabbitMQ.html" class="prev">
        RabbitMQ
      </a></span> <span class="next"><a href="/doc-vuepress/JavaEE/Spring Cloud.html">
        Spring Cloud
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/doc-vuepress/assets/js/app.d9f058a2.js" defer></script><script src="/doc-vuepress/assets/js/2.3b3db5cf.js" defer></script><script src="/doc-vuepress/assets/js/55.c593a0bd.js" defer></script>
  </body>
</html>
