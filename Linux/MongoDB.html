<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB | Chiriri</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/doc-vuepress/favicon.ico">
    <meta name="description" content="Chiriridesu">
    
    <link rel="preload" href="/doc-vuepress/assets/css/0.styles.71c39aa4.css" as="style"><link rel="preload" href="/doc-vuepress/assets/js/app.b1672c91.js" as="script"><link rel="preload" href="/doc-vuepress/assets/js/2.3b3db5cf.js" as="script"><link rel="preload" href="/doc-vuepress/assets/js/130.c52db2c9.js" as="script"><link rel="prefetch" href="/doc-vuepress/assets/js/10.666dc73a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/100.0a098c90.js"><link rel="prefetch" href="/doc-vuepress/assets/js/101.85f1d572.js"><link rel="prefetch" href="/doc-vuepress/assets/js/102.d541c1aa.js"><link rel="prefetch" href="/doc-vuepress/assets/js/103.ed02d10c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/104.28020878.js"><link rel="prefetch" href="/doc-vuepress/assets/js/105.6ef08bb9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/106.1c09e5ff.js"><link rel="prefetch" href="/doc-vuepress/assets/js/107.c0e5e795.js"><link rel="prefetch" href="/doc-vuepress/assets/js/108.c036de52.js"><link rel="prefetch" href="/doc-vuepress/assets/js/109.ddc805f4.js"><link rel="prefetch" href="/doc-vuepress/assets/js/11.85ab95e3.js"><link rel="prefetch" href="/doc-vuepress/assets/js/110.4ef712b9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/111.94196968.js"><link rel="prefetch" href="/doc-vuepress/assets/js/112.8ed1fcfe.js"><link rel="prefetch" href="/doc-vuepress/assets/js/113.86298697.js"><link rel="prefetch" href="/doc-vuepress/assets/js/114.f89b8c54.js"><link rel="prefetch" href="/doc-vuepress/assets/js/115.c6b78bff.js"><link rel="prefetch" href="/doc-vuepress/assets/js/116.f359efb9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/117.15693d60.js"><link rel="prefetch" href="/doc-vuepress/assets/js/118.1ec00915.js"><link rel="prefetch" href="/doc-vuepress/assets/js/119.7ebdba32.js"><link rel="prefetch" href="/doc-vuepress/assets/js/12.50b597d1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/120.07c8cf5a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/121.2c318447.js"><link rel="prefetch" href="/doc-vuepress/assets/js/122.61018ec9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/123.94ecbe9b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/124.8fb9f60c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/125.4ad17dc1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/126.0e87444a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/127.39e9bf86.js"><link rel="prefetch" href="/doc-vuepress/assets/js/128.1d03d72b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/129.15a76553.js"><link rel="prefetch" href="/doc-vuepress/assets/js/13.9a4f426d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/131.95779b52.js"><link rel="prefetch" href="/doc-vuepress/assets/js/132.c82522fd.js"><link rel="prefetch" href="/doc-vuepress/assets/js/133.f1617f43.js"><link rel="prefetch" href="/doc-vuepress/assets/js/134.65ab4498.js"><link rel="prefetch" href="/doc-vuepress/assets/js/135.9341bf11.js"><link rel="prefetch" href="/doc-vuepress/assets/js/136.9bd46a22.js"><link rel="prefetch" href="/doc-vuepress/assets/js/137.458108cb.js"><link rel="prefetch" href="/doc-vuepress/assets/js/138.427ada35.js"><link rel="prefetch" href="/doc-vuepress/assets/js/139.238a6652.js"><link rel="prefetch" href="/doc-vuepress/assets/js/14.dfef0524.js"><link rel="prefetch" href="/doc-vuepress/assets/js/140.93334b90.js"><link rel="prefetch" href="/doc-vuepress/assets/js/141.9fbf7243.js"><link rel="prefetch" href="/doc-vuepress/assets/js/142.8b96485d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/143.eacd1093.js"><link rel="prefetch" href="/doc-vuepress/assets/js/144.be8f7d11.js"><link rel="prefetch" href="/doc-vuepress/assets/js/145.59244fbe.js"><link rel="prefetch" href="/doc-vuepress/assets/js/146.d43ef659.js"><link rel="prefetch" href="/doc-vuepress/assets/js/147.c5340d60.js"><link rel="prefetch" href="/doc-vuepress/assets/js/148.3770594a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/149.e9aecdd1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/15.f6c1af5d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/150.1b481898.js"><link rel="prefetch" href="/doc-vuepress/assets/js/151.48519686.js"><link rel="prefetch" href="/doc-vuepress/assets/js/152.4fe7b97a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/153.7944f896.js"><link rel="prefetch" href="/doc-vuepress/assets/js/154.a5cd7a63.js"><link rel="prefetch" href="/doc-vuepress/assets/js/155.ea90d02b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/156.e718da77.js"><link rel="prefetch" href="/doc-vuepress/assets/js/157.25464da8.js"><link rel="prefetch" href="/doc-vuepress/assets/js/158.4e943d8e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/159.a556cdb0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/16.02bd7e8e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/160.b1360202.js"><link rel="prefetch" href="/doc-vuepress/assets/js/161.3a31aac1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/162.7a9615ba.js"><link rel="prefetch" href="/doc-vuepress/assets/js/163.b1880a32.js"><link rel="prefetch" href="/doc-vuepress/assets/js/164.c4c1fd71.js"><link rel="prefetch" href="/doc-vuepress/assets/js/165.af1463a4.js"><link rel="prefetch" href="/doc-vuepress/assets/js/166.5f553d7f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/167.199e3b3c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/168.6314d015.js"><link rel="prefetch" href="/doc-vuepress/assets/js/169.f3eaf5f7.js"><link rel="prefetch" href="/doc-vuepress/assets/js/17.eab1776f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/170.fcb27332.js"><link rel="prefetch" href="/doc-vuepress/assets/js/171.457da777.js"><link rel="prefetch" href="/doc-vuepress/assets/js/172.a76423eb.js"><link rel="prefetch" href="/doc-vuepress/assets/js/173.aa18ebef.js"><link rel="prefetch" href="/doc-vuepress/assets/js/174.c2c81390.js"><link rel="prefetch" href="/doc-vuepress/assets/js/175.f416c348.js"><link rel="prefetch" href="/doc-vuepress/assets/js/176.06e50096.js"><link rel="prefetch" href="/doc-vuepress/assets/js/177.3ef260a1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/178.861998d9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/179.06f9245a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/18.c8bb5454.js"><link rel="prefetch" href="/doc-vuepress/assets/js/180.48cd52ef.js"><link rel="prefetch" href="/doc-vuepress/assets/js/181.5268edaa.js"><link rel="prefetch" href="/doc-vuepress/assets/js/182.df63ea49.js"><link rel="prefetch" href="/doc-vuepress/assets/js/183.21c31f4d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/184.41753c99.js"><link rel="prefetch" href="/doc-vuepress/assets/js/185.4856832c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/186.6990be7b.js"><link rel="prefetch" href="/doc-vuepress/assets/js/187.e7bc7992.js"><link rel="prefetch" href="/doc-vuepress/assets/js/188.172df96c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/189.e682de79.js"><link rel="prefetch" href="/doc-vuepress/assets/js/19.e77f86e5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/190.3afa2fbe.js"><link rel="prefetch" href="/doc-vuepress/assets/js/191.9a4273b5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/192.6ebc3531.js"><link rel="prefetch" href="/doc-vuepress/assets/js/193.a37f4bc9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/194.ce2b5c83.js"><link rel="prefetch" href="/doc-vuepress/assets/js/20.b0cd8e95.js"><link rel="prefetch" href="/doc-vuepress/assets/js/21.ddd86fe0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/22.0ff354d0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/23.947e95fd.js"><link rel="prefetch" href="/doc-vuepress/assets/js/24.c8ed0fbd.js"><link rel="prefetch" href="/doc-vuepress/assets/js/25.018a14b6.js"><link rel="prefetch" href="/doc-vuepress/assets/js/26.08ca217e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/27.5a76b030.js"><link rel="prefetch" href="/doc-vuepress/assets/js/28.98dbc8f8.js"><link rel="prefetch" href="/doc-vuepress/assets/js/29.d4a43ec9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/3.39abf8a9.js"><link rel="prefetch" href="/doc-vuepress/assets/js/30.54f40361.js"><link rel="prefetch" href="/doc-vuepress/assets/js/31.87ec1b2e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/32.2018a1ae.js"><link rel="prefetch" href="/doc-vuepress/assets/js/33.b1051a51.js"><link rel="prefetch" href="/doc-vuepress/assets/js/34.d1550c3f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/35.3a82e048.js"><link rel="prefetch" href="/doc-vuepress/assets/js/36.bc2b3255.js"><link rel="prefetch" href="/doc-vuepress/assets/js/37.a6f99457.js"><link rel="prefetch" href="/doc-vuepress/assets/js/38.a5858ebe.js"><link rel="prefetch" href="/doc-vuepress/assets/js/39.479e20dc.js"><link rel="prefetch" href="/doc-vuepress/assets/js/4.851bf8c4.js"><link rel="prefetch" href="/doc-vuepress/assets/js/40.868120a2.js"><link rel="prefetch" href="/doc-vuepress/assets/js/41.a6bf308a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/42.c37e09e3.js"><link rel="prefetch" href="/doc-vuepress/assets/js/43.a8298eaf.js"><link rel="prefetch" href="/doc-vuepress/assets/js/44.0b08e0e3.js"><link rel="prefetch" href="/doc-vuepress/assets/js/45.3d363f61.js"><link rel="prefetch" href="/doc-vuepress/assets/js/46.ca15b330.js"><link rel="prefetch" href="/doc-vuepress/assets/js/47.ebe45cac.js"><link rel="prefetch" href="/doc-vuepress/assets/js/48.4ddbbdca.js"><link rel="prefetch" href="/doc-vuepress/assets/js/49.c6e02072.js"><link rel="prefetch" href="/doc-vuepress/assets/js/5.e09897f2.js"><link rel="prefetch" href="/doc-vuepress/assets/js/50.9ddccbc1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/51.26d914ea.js"><link rel="prefetch" href="/doc-vuepress/assets/js/52.3b443edc.js"><link rel="prefetch" href="/doc-vuepress/assets/js/53.340acb97.js"><link rel="prefetch" href="/doc-vuepress/assets/js/54.c5a4684d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/55.db2cb7c0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/56.dc616c9f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/57.4613a350.js"><link rel="prefetch" href="/doc-vuepress/assets/js/58.b8ae2182.js"><link rel="prefetch" href="/doc-vuepress/assets/js/59.688c3790.js"><link rel="prefetch" href="/doc-vuepress/assets/js/6.7862f44a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/60.aa9d0d9c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/61.c6709445.js"><link rel="prefetch" href="/doc-vuepress/assets/js/62.549ca843.js"><link rel="prefetch" href="/doc-vuepress/assets/js/63.2772d45c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/64.2e80eee1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/65.6189a1f4.js"><link rel="prefetch" href="/doc-vuepress/assets/js/66.6bd6476d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/67.bf6bb46a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/68.baf5d40e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/69.5080d15d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/7.703c8b54.js"><link rel="prefetch" href="/doc-vuepress/assets/js/70.43de9e33.js"><link rel="prefetch" href="/doc-vuepress/assets/js/71.c3d60ec1.js"><link rel="prefetch" href="/doc-vuepress/assets/js/72.c2411038.js"><link rel="prefetch" href="/doc-vuepress/assets/js/73.0208f06a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/74.4de1bf4e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/75.05be534e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/76.884b8dd0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/77.c7f53284.js"><link rel="prefetch" href="/doc-vuepress/assets/js/78.22d394a0.js"><link rel="prefetch" href="/doc-vuepress/assets/js/79.f409a028.js"><link rel="prefetch" href="/doc-vuepress/assets/js/8.6471eaab.js"><link rel="prefetch" href="/doc-vuepress/assets/js/80.86c788b5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/81.9c1eebb5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/82.945b44d7.js"><link rel="prefetch" href="/doc-vuepress/assets/js/83.f6f98840.js"><link rel="prefetch" href="/doc-vuepress/assets/js/84.2d4a2706.js"><link rel="prefetch" href="/doc-vuepress/assets/js/85.182716e8.js"><link rel="prefetch" href="/doc-vuepress/assets/js/86.41e07e9a.js"><link rel="prefetch" href="/doc-vuepress/assets/js/87.0702b2f5.js"><link rel="prefetch" href="/doc-vuepress/assets/js/88.e5c83560.js"><link rel="prefetch" href="/doc-vuepress/assets/js/89.145c37c8.js"><link rel="prefetch" href="/doc-vuepress/assets/js/9.9fc18b40.js"><link rel="prefetch" href="/doc-vuepress/assets/js/90.73f40e19.js"><link rel="prefetch" href="/doc-vuepress/assets/js/91.83021d9e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/92.ac94328c.js"><link rel="prefetch" href="/doc-vuepress/assets/js/93.e9b56653.js"><link rel="prefetch" href="/doc-vuepress/assets/js/94.88abc35f.js"><link rel="prefetch" href="/doc-vuepress/assets/js/95.9f3cd06e.js"><link rel="prefetch" href="/doc-vuepress/assets/js/96.01da7e7d.js"><link rel="prefetch" href="/doc-vuepress/assets/js/97.fd1f8775.js"><link rel="prefetch" href="/doc-vuepress/assets/js/98.a9e9ea40.js"><link rel="prefetch" href="/doc-vuepress/assets/js/99.a32d5b85.js">
    <link rel="stylesheet" href="/doc-vuepress/assets/css/0.styles.71c39aa4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/doc-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">Chiriri</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/doc-vuepress/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/JavaSE/" class="nav-link">
  JavaSE
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/JavaEE/" class="nav-link">
  JavaEE
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Linux/" class="nav-link router-link-active">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/SQL/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/Hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Hive/" class="nav-link">
  Hive
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/前端/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Vue/" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/doc-vuepress/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/JavaSE/" class="nav-link">
  JavaSE
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/JavaEE/" class="nav-link">
  JavaEE
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Linux/" class="nav-link router-link-active">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/SQL/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/Hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Hive/" class="nav-link">
  Hive
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc-vuepress/前端/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/doc-vuepress/Vue/" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/doc-vuepress/Linux/Linux.html" class="sidebar-link">Linux</a></li><li><a href="/doc-vuepress/Linux/Shell.html" class="sidebar-link">Shell</a></li><li><a href="/doc-vuepress/Linux/Nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/doc-vuepress/Linux/Java.html" class="sidebar-link">Java</a></li><li><a href="/doc-vuepress/Linux/Tomcat.html" class="sidebar-link">Tomcat</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mongodb"><a href="#mongodb" class="header-anchor">#</a> MongoDB</h1> <p>MongoDB它支持的数据结构非常松散,是一种类JSON的格式 BSON 它即可以存储比较复杂的数据类型 又相当的灵活</p> <p>MongoDB中的记录是一个文档 它是一个键值对数据结构 MongoDB文档类似于JSON对象 即一个文档认为就是一个对象</p> <h2 id="体系结构"><a href="#体系结构" class="header-anchor">#</a> 体系结构</h2> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211013181311490.png" alt="image-20211013181311490"></p> <h2 id="数据模型"><a href="#数据模型" class="header-anchor">#</a> 数据模型</h2> <p>MongoDB的最小存储单位就是文档(document)对象。文档(document)对象对应于关系型数据库的行。数据在MongoDB中以BSON（Binary-JSON）文档的格式存储在磁盘上。</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211013181407612.png" alt="image-20211013181407612"></p> <h2 id="单机部署"><a href="#单机部署" class="header-anchor">#</a> 单机部署</h2> <p>https://www.mongodb.com/try/download/community</p> <p>MongoDB的版本命名规范如：x.y.z；
y为奇数时表示当前版本为开发版，如：1.5.2、4.1.13；
y为偶数时表示当前版本为稳定版，如：1.6.3、4.0.10；
z是修正版本号，数字越大越好。</p> <h3 id="windows启动"><a href="#windows启动" class="header-anchor">#</a> windows启动</h3> <ol><li><p>解压到本地</p></li> <li><p>在MongoDB目录下创建 data</p></li> <li><p>在data文件夹下 分别创建 db 和 logs 文件夹</p></li> <li><p>进入bin目录下命令行启动</p> <div class="language-sh extra-class"><pre class="language-sh"><code>mongod --dbpath<span class="token operator">=</span>D:<span class="token punctuation">\</span>compile<span class="token punctuation">\</span>mongodb-win32-x86_64-2012plus-4.2.16<span class="token punctuation">\</span>data<span class="token punctuation">\</span>db --logpath<span class="token operator">=</span>D:<span class="token punctuation">\</span>compile<span class="token punctuation">\</span>mongodb-win32-x86_64-2012plus-4.2.16<span class="token punctuation">\</span>data<span class="token punctuation">\</span>logs<span class="token punctuation">\</span>mongolog.log --logappend
</code></pre></div></li></ol> <p>MongoDB默认端口为27017 如果要指定端口可以通过--port来设置</p> <div class="language-sh extra-class"><pre class="language-sh"><code>mongod --dbpath<span class="token operator">=</span>D:<span class="token punctuation">\</span>compile<span class="token punctuation">\</span>mongodb-win32-x86_64-2012plus-4.2.16<span class="token punctuation">\</span>data<span class="token punctuation">\</span>db --logpath<span class="token operator">=</span>D:<span class="token punctuation">\</span>compile<span class="token punctuation">\</span>mongodb-win32-x86_64-2012plus-4.2.16<span class="token punctuation">\</span>data<span class="token punctuation">\</span>logs<span class="token punctuation">\</span>mongolog.log --logappend --port <span class="token number">27018</span>
</code></pre></div><h4 id="使用配置文件启动"><a href="#使用配置文件启动" class="header-anchor">#</a> 使用配置文件启动</h4> <ol><li><p>在MongoDB目录下conf目录</p></li> <li><p>进入conf目录创建mongod.conf</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\compile\mongodb<span class="token punctuation">-</span>win32<span class="token punctuation">-</span>x86_64<span class="token punctuation">-</span>2012plus<span class="token punctuation">-</span>4.2.16\data\db
<span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token key atrule">path</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\compile\mongodb<span class="token punctuation">-</span>win32<span class="token punctuation">-</span>x86_64<span class="token punctuation">-</span>2012plus<span class="token punctuation">-</span>4.2.16\data\logs\mongolog.log
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div></li> <li><p>在bin目录下命令行启动</p> <div class="language-sh extra-class"><pre class="language-sh"><code>mongod -f <span class="token punctuation">..</span>/config/mongod.conf
<span class="token comment">#或者</span>
mongod --config <span class="token punctuation">..</span>/config/mongod.conf
</code></pre></div></li></ol> <h4 id="连接数据库"><a href="#连接数据库" class="header-anchor">#</a> 连接数据库</h4> <ol><li><p>在bin目录下命令行启动</p> <div class="language-sh extra-class"><pre class="language-sh"><code>mongo
<span class="token comment">#或者</span>
mongo --host<span class="token operator">=</span><span class="token number">127.0</span>.0.1 --port<span class="token operator">=</span><span class="token number">27017</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>show dbs<span class="token punctuation">;</span> <span class="token comment">#查询数据库</span>
<span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token comment">#退出</span>
</code></pre></div></li></ol> <h4 id="安装为服务项"><a href="#安装为服务项" class="header-anchor">#</a> 安装为服务项</h4> <p>在bin目录下执行</p> <div class="language-sh extra-class"><pre class="language-sh"><code>mongod --dbpath <span class="token string">&quot;D:<span class="token entity" title="\c">\c</span>ompile\mongodb-win32-x86_64-2012plus-4.2.16\data\db&quot;</span> --logpath <span class="token string">&quot;D:<span class="token entity" title="\c">\c</span>ompile\mongodb-win32-x86_64-2012plus-4.2.16\data\logs\mongolog.log&quot;</span> --serviceName <span class="token string">&quot;mongodb&quot;</span> --serviceDisplayName <span class="token string">&quot;mongodb&quot;</span> --install
net start mongodb
</code></pre></div><h3 id="linux启动"><a href="#linux启动" class="header-anchor">#</a> Linux启动</h3> <p>解压安装</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">wget</span> https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.2.15.tgz
<span class="token function">tar</span> -zxvf mongodb-linux-x86_64-rhel70-4.2.15.tgz
<span class="token function">mv</span> mongodb-linux-x86_64-rhel70-4.2.15 /usr/local/mongodb 
<span class="token function">mkdir</span> -p /mongodb/single/data/db  <span class="token comment">#数据目录</span>
<span class="token function">mkdir</span> -p /mongodb/single/log  <span class="token comment">#日志文件</span>
<span class="token function">vim</span> /mongodb/single/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 配置内容</span>
<span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment"># MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token comment"># The path of the log file to which mongod or mongos should send all diagnostic logging information</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment"># mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/single/log/mongod.log&quot;</span>
 <span class="token comment"># 当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment"># mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token comment"># The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;.</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/single/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
  <span class="token comment"># 启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment"># 启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment"># 服务实例绑定的IP，默认是localhost</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212    <span class="token comment">#ip为当前服务器局域网ip地址 不设置外部无法通过ip访问</span>
 <span class="token comment"># bindIp</span>
 <span class="token comment"># 绑定的端口，默认是27017</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
</code></pre></div><p>启动</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf
<span class="token comment">#/usr/local/mongodb/bin/mongod --config /mongodb/single/mongod.conf</span>
<span class="token comment">#查看防火墙状态</span>
systemctl status firewalld
<span class="token comment">#临时关闭防火墙</span>
systemctl stop firewalld
<span class="token comment">#开机禁止启动防火墙</span>
systemctl disable firewalld
</code></pre></div><p>如果一旦数据损坏 导致表死锁</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">rm</span> -f /mongodb/single/data/db/*.lock <span class="token comment">#删除锁文件</span>
/usr/local/mongdb/bin/mongod --repair
</code></pre></div><h4 id="配置环境变量"><a href="#配置环境变量" class="header-anchor">#</a> 配置环境变量</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vi</span> /etc/profile
<span class="token comment">#配置内容</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MONGODB_HOME</span><span class="token operator">=</span>/usr/local/mongodb
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$MONGODB_HOME</span>/bin
</code></pre></div><h4 id="配置为服务加入启动"><a href="#配置为服务加入启动" class="header-anchor">#</a> 配置为服务加入启动</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /lib/systemd/system  
<span class="token function">vi</span> mongodb.service  
<span class="token comment">#配置内容</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>mongodb
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target remote-fs.target nss-lookup.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/mongodb/bin/mongod --config /mongodb/single/mongodb.conf
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill -s HUP <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/local/mongodb/bin/mongod --shutdown --config /mongodb/single/mongodb.conf
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>true

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;/usr/local/mongodb/bin/mongod --dbpath=/data/db --fork --bind_ip=0.0.0.0 --port 27017 --logpath=/data/db/log --logappend --auth&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/rc.local

<span class="token function">chmod</span> <span class="token number">754</span> mongodb.service
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#启动服务</span>
systemctl start mongodb.service
<span class="token comment">#关闭服务</span>
systemctl stop mongodb.service
<span class="token comment">#开机启动</span>
systemctl <span class="token builtin class-name">enable</span> mongodb.service
<span class="token comment">#关闭开启启动</span>
systemctl disable mongodb.service
</code></pre></div><h4 id="标准的关闭方法"><a href="#标准的关闭方法" class="header-anchor">#</a> 标准的关闭方法</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>mongo
use admin
db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>进程id关闭法</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> mongo
<span class="token function">kill</span> -2 pid
</code></pre></div><h2 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h2> <h3 id="选择和创建数据库"><a href="#选择和创建数据库" class="header-anchor">#</a> 选择和创建数据库</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#use 数据库名称   </span>
use articledb  <span class="token comment">#如果没有此数据库则自动创建 </span>
<span class="token comment">#如果新的数据库没有插入数据 showdbs是无法查看到新创建的数据库 因为此时数据库存储在内存当中 并未持久化</span>
</code></pre></div><h3 id="查询当前有权限查看的数据"><a href="#查询当前有权限查看的数据" class="header-anchor">#</a> 查询当前有权限查看的数据</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>show dbs
<span class="token comment">#或者</span>
show databases
</code></pre></div><h3 id="查看当前正在使用的数据库名称"><a href="#查看当前正在使用的数据库名称" class="header-anchor">#</a> 查看当前正在使用的数据库名称</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>db
</code></pre></div><h3 id="数据库命名规范"><a href="#数据库命名规范" class="header-anchor">#</a> 数据库命名规范</h3> <p>数据库名可以是满足以下条件的任意UTF-8字符串。</p> <ul><li>不能是空字符串（ &quot;&quot;)。</li> <li>不得含有 ' '（空格)、.、$、/、\和\0 (空字符)。</li> <li>应全部<strong>小写</strong>。</li> <li>最多 64字节。</li></ul> <p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。</p> <h3 id="默认三个数据库作用"><a href="#默认三个数据库作用" class="header-anchor">#</a> 默认三个数据库作用</h3> <ul><li><strong>admin</strong> ： 从权限的角度来看，这是&quot;root&quot;数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</li> <li><strong>local</strong>: 这个数据<strong>永远不会被复制</strong>，可以用来存储限于本地单台服务器的任意集合</li> <li><strong>config</strong> : 当Mongo用于分片设置时，config数据库在内部使用，用于<strong>保存分片的相关信息</strong>。</li></ul> <h3 id="数据库删除"><a href="#数据库删除" class="header-anchor">#</a> 数据库删除</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>db.dropDatabase<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#删除当前使用的库</span>
</code></pre></div><h2 id="集合"><a href="#集合" class="header-anchor">#</a> 集合</h2> <p>集合,类似于关系型数据中的表</p> <h3 id="显式创建"><a href="#显式创建" class="header-anchor">#</a> 显式创建</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.createCollection(集合名)</span>
db.createCollection<span class="token punctuation">(</span><span class="token string">&quot;my&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#成功返回1</span>
</code></pre></div><h3 id="隐式创建"><a href="#隐式创建" class="header-anchor">#</a> 隐式创建</h3> <p>当向一个集合中插入文档时 如果集合不存在 则自动创建集合</p> <p>通常我们使用隐式创建文档即可</p> <h3 id="查询集合"><a href="#查询集合" class="header-anchor">#</a> 查询集合</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>show collections <span class="token comment">#查询当前库的所有集合</span>
</code></pre></div><h3 id="集合删除"><a href="#集合删除" class="header-anchor">#</a> 集合删除</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.集合名.drop()</span>
db.my.drop<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#成功则返回true</span>
</code></pre></div><h2 id="文档crud"><a href="#文档crud" class="header-anchor">#</a> 文档CRUD</h2> <p>文档的数据结构和JSON基本一样</p> <p>索引存储在集合中数据都是 BSON 格式</p> <h3 id="插入"><a href="#插入" class="header-anchor">#</a> 插入</h3> <p>通过insert() 或者 save()  方法向集合中插入文档</p> <h4 id="单问插入"><a href="#单问插入" class="header-anchor">#</a> 单问插入</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#单文档插入</span>
db.collection.insert<span class="token punctuation">(</span>
 <span class="token operator">&lt;</span>document or array of documents<span class="token operator">&gt;</span>,
 <span class="token punctuation">{</span>
  writeConcern: <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span>,
  ordered: <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014200121256.png" alt="image-20211014200121256"></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.集合名.inset({&quot;&quot;})</span>
<span class="token comment">#单文档插入</span>
db.comment.insert<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100000&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;今天天气真好，阳光明媚&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1001&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Rose&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span>:null<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#返回1则插入成功</span>
</code></pre></div><h4 id="批量插入"><a href="#批量插入" class="header-anchor">#</a> 批量插入</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#批量插入</span>
db.collection.insertMany<span class="token punctuation">(</span>
 <span class="token punctuation">[</span> <span class="token operator">&lt;</span>document <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> , <span class="token operator">&lt;</span>document <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>, <span class="token punctuation">..</span>. <span class="token punctuation">]</span>,
 <span class="token punctuation">{</span>
   writeConcern: <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span>,
   ordered: <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">#db.集合名.insertMany([{&quot;&quot;},{&quot;&quot;}])</span>
db.comment.insertMany<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1002&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;相忘于江湖&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-05T22:08:15.522Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1005&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;伊人憔悴&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-05T23:58:51.485Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">888</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;3&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;我一直喝凉开水，冬天夏天都喝。&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1004&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;杰克船长&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-06T01:05:06.321Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;4&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;专家说不能空腹吃饭，影响健康。&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1003&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;凯撒&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-06T08:18:35.288Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;研究表明，刚烧开的水千万不能喝，因为烫嘴。&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1003&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;凯撒&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-06T11:01:02.521Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre></div><h4 id="try-catch"><a href="#try-catch" class="header-anchor">#</a> try catch</h4> <p>我们通过批量插入时由于数据较多可能会出现失败 我们可以通过try catch进行异常处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  db<span class="token punctuation">.</span>comment<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      _id<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
      articleid<span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。'</span><span class="token punctuation">,</span>
      userid<span class="token operator">:</span> <span class="token string">'1002'</span><span class="token punctuation">,</span>
      nickname<span class="token operator">:</span> <span class="token string">'相忘于江湖'</span><span class="token punctuation">,</span>
      createdatetime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-05T22:08:15.522Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      likenum<span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      _id<span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
      articleid<span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'我夏天空腹喝凉开水，冬天喝温开水'</span><span class="token punctuation">,</span>
      userid<span class="token operator">:</span> <span class="token string">'1005'</span><span class="token punctuation">,</span>
      nickname<span class="token operator">:</span> <span class="token string">'伊人憔悴'</span><span class="token punctuation">,</span>
      createdatetime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-05T23:58:51.485Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      likenum<span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">888</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      _id<span class="token operator">:</span> <span class="token string">'3'</span><span class="token punctuation">,</span>
      articleid<span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'我一直喝凉开水，冬天夏天都喝。'</span><span class="token punctuation">,</span>
      userid<span class="token operator">:</span> <span class="token string">'1004'</span><span class="token punctuation">,</span>
      nickname<span class="token operator">:</span> <span class="token string">'杰克船长'</span><span class="token punctuation">,</span>
      createdatetime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-06T01:05:06.321Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      likenum<span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      _id<span class="token operator">:</span> <span class="token string">'4'</span><span class="token punctuation">,</span>
      articleid<span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'专家说不能空腹吃饭，影响健康。'</span><span class="token punctuation">,</span>
      userid<span class="token operator">:</span> <span class="token string">'1003'</span><span class="token punctuation">,</span>
      nickname<span class="token operator">:</span> <span class="token string">'凯撒'</span><span class="token punctuation">,</span>
      createdatetime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-06T08:18:35.288Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      likenum<span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      _id<span class="token operator">:</span> <span class="token string">'5'</span><span class="token punctuation">,</span>
      articleid<span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'研究表明，刚烧开的水千万不能喝，因为烫嘴。'</span><span class="token punctuation">,</span>
      userid<span class="token operator">:</span> <span class="token string">'1003'</span><span class="token punctuation">,</span>
      nickname<span class="token operator">:</span> <span class="token string">'凯撒'</span><span class="token punctuation">,</span>
      createdatetime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-06T11:01:02.521Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      likenum<span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="查询"><a href="#查询" class="header-anchor">#</a> 查询</h3> <p>查询当前数据库中的文档</p> <h4 id="查询所有文档"><a href="#查询所有文档" class="header-anchor">#</a> 查询所有文档</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.collection.find(&lt;query&gt;, [projection])</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014200519924.png" alt="image-20211014200519924"></p> <h4 id="条件查询"><a href="#条件查询" class="header-anchor">#</a> 条件查询</h4> <p>查询文档中包含此文档内容的所有文档</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.collection.find({键:&quot;内容&quot;})</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>articleid:<span class="token string">&quot;100001&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="只返回第一个结果"><a href="#只返回第一个结果" class="header-anchor">#</a> 只返回第一个结果</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.collection.findOne({键:&quot;内容&quot;})</span>
db.comment.findOne<span class="token punctuation">(</span><span class="token punctuation">{</span>articleid:<span class="token string">&quot;100001&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="投影查询"><a href="#投影查询" class="header-anchor">#</a> 投影查询</h4> <p>查询出来的文档 只显示需要的键值对 相对应sql中的查询结果只显示指定列</p> <p>find传参时给出指定的键字段  1为查询此键  0为过滤此键   默认自动包含查询_id键</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.collection.find({键:&quot;内容&quot;},{键:1,键:0})  </span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>articleid:<span class="token string">&quot;100001&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>content:1<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#查询包含100001文档中的 content键内容</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>articleid:<span class="token string">&quot;100001&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>content:1,_id:0<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#默认查询包含_id 可以通过0过滤</span>

</code></pre></div><h3 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h3> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> update<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token comment">//或</span>
db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>
	<span class="token operator">&lt;</span>query<span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token operator">&lt;</span>update<span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
		upsert<span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">,</span>
		multi<span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">,</span>
		writeConcern<span class="token operator">:</span> <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span><span class="token punctuation">,</span>
		collation<span class="token operator">:</span> <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span><span class="token punctuation">,</span>
		arrayFilters<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">&lt;</span>filterdocument1<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
		hint<span class="token operator">:</span> 	<span class="token operator">&lt;</span>document<span class="token operator">|</span>string<span class="token operator">&gt;</span> 				<span class="token comment">// Available starting in MongoDB 4.2</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014202959460.png" alt="image-20211014202959460"></p> <h4 id="覆盖修改"><a href="#覆盖修改" class="header-anchor">#</a> 覆盖修改</h4> <p>修改指定文档 并覆盖更新整个文档 即修改为当前语句中的字段 原先字段不保留</p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.update<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>likenum:NumberInt<span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#可以理解为删除原文档并插入此文档</span>
</code></pre></div><h4 id="局部修改"><a href="#局部修改" class="header-anchor">#</a> 局部修改</h4> <p>我们可以通过修改器<code>$set</code>来修改指定键的内容  并保留原文档其他内容</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#默认只修改符合条件的第一条数据</span>
db.comment.update<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$set</span>:<span class="token punctuation">{</span>likenum:NumberInt<span class="token punctuation">(</span><span class="token number">778</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">#修改所有符合条件的数据需要加上参数{multi:true}</span>
db.comment.update<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:<span class="token string">&quot;1003&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$set</span>:<span class="token punctuation">{</span>nickname:<span class="token string">&quot;张三&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>multi:true<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="列值增长修改"><a href="#列值增长修改" class="header-anchor">#</a> 列值增长修改</h4> <p>通过<code>$inc</code>运算符实现 可以对该键的值进行递增 递减</p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.update<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$inc</span>:<span class="token punctuation">{</span>likenum:NumberInt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="删除"><a href="#删除" class="header-anchor">#</a> 删除</h3> <h4 id="条件删除"><a href="#条件删除" class="header-anchor">#</a> 条件删除</h4> <p>删除符合条件的文档</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.集合.remove({条件})</span>
db.comment.remove<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#返回值为删除多少条数据</span>
</code></pre></div><h4 id="删除全部"><a href="#删除全部" class="header-anchor">#</a> 删除全部</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.remove<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="文档的分页查询"><a href="#文档的分页查询" class="header-anchor">#</a> 文档的分页查询</h2> <h3 id="统计查询"><a href="#统计查询" class="header-anchor">#</a> 统计查询</h3> <p>使用count()方法</p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.collection.count<span class="token punctuation">(</span>query, options<span class="token punctuation">)</span>
</code></pre></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014205136962.png" alt="image-20211014205136962"></p> <h4 id="统计当前集合所有文档数"><a href="#统计当前集合所有文档数" class="header-anchor">#</a> 统计当前集合所有文档数</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.count<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#返回值是文档数</span>
</code></pre></div><h4 id="按条件查询"><a href="#按条件查询" class="header-anchor">#</a> 按条件查询</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.count<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:<span class="token string">&quot;1003&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre></div><h3 id="分页列表查询"><a href="#分页列表查询" class="header-anchor">#</a> 分页列表查询</h3> <p>通过limit()方法 读取指定数量的数据 使用skip()方法跳过指定数量的数据</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.collection.find().limit(number).skip(number)</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment">#查询前3条的数据</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.skip<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">#跳过前3条的数据</span>

db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.skip<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">#第一页</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.skip<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">#第二页</span>
</code></pre></div><h3 id="排序查询"><a href="#排序查询" class="header-anchor">#</a> 排序查询</h3> <p>sort()方法对数据进行排序  使用1和-1来指定升序和降序  sort({键:1})  默认以id进行升序</p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.sort<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:-1,likenum:1<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#对userid的内容进行降序 再对likenum的内容进行升序</span>
</code></pre></div><h3 id="分页和排序查询的顺序"><a href="#分页和排序查询的顺序" class="header-anchor">#</a> 分页和排序查询的顺序</h3> <p>skip(), limilt(), sort()三个放在一起执行的时候，执行的顺序是先 sort(), 然后是 skip()，最后是显示的 limit()，和命令编写顺序无关。</p> <h2 id="高级查询"><a href="#高级查询" class="header-anchor">#</a> 高级查询</h2> <h3 id="正则条件查询"><a href="#正则条件查询" class="header-anchor">#</a> 正则条件查询</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.集合.find({键:/正则表达式/})</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>content:/^专家/<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="比较查询"><a href="#比较查询" class="header-anchor">#</a> 比较查询</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$gt</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 大于: field &gt; value</span>
db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$lt</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 小于: field &lt; value</span>
db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$gte</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 大于等于: field &gt;= value</span>
db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$lte</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 小于等于: field &lt;= value</span>
db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$ne</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 不等于: field != value</span>

<span class="token comment">#例子</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$gt</span>:NumberInt<span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="包含查询"><a href="#包含查询" class="header-anchor">#</a> 包含查询</h3> <p>使用<code>$in</code> 查询包含指定内容的文档</p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:<span class="token punctuation">{</span><span class="token variable">$in</span>:<span class="token punctuation">[</span><span class="token string">&quot;1003&quot;</span>,<span class="token string">&quot;1004&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="不包含查询"><a href="#不包含查询" class="header-anchor">#</a> 不包含查询</h3> <p>使用<code>$nin</code> 查询不包含指定内容的文档</p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:<span class="token punctuation">{</span><span class="token variable">$nin</span>:<span class="token punctuation">[</span><span class="token string">&quot;1003&quot;</span>,<span class="token string">&quot;1004&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="条件连接查询"><a href="#条件连接查询" class="header-anchor">#</a> 条件连接查询</h3> <p>前面我们通过<code>$set</code>查询单条件的文档  如果为多条件则需要使用 <code>$and</code>进行查询</p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token variable">$and</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$gte</span>:NumberInt<span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$lt</span>:NumberInt<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment"># 查询likenum 大于等于700 并且小于2000的文档</span>

</code></pre></div><h4 id="或者连接"><a href="#或者连接" class="header-anchor">#</a> 或者连接</h4> <p>使用<code>$or</code>进行查询</p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token variable">$or</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$gte</span>:NumberInt<span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$lt</span>:NumberInt<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment"># 查询likenum 大于等于700 并且小于2000的文档</span>
</code></pre></div><h2 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h2> <p>MongoDB没有下索引下 是进行全集合扫描 如果数据量较大时查询效率非常低</p> <p>MongoDB索引使用B树数据结构(B-Tree,MySQL是B+Tree)</p> <h3 id="单字段索引"><a href="#单字段索引" class="header-anchor">#</a> 单字段索引</h3> <p>MongoDB支持在文档的单个字段上创建用户定义的升序/降序索引 称为单字段索引</p> <p>对于单个字段索引和排序操作，索引键的排序顺序（即升序或降序）并不重要，因为MongoDB可以在任何方向上遍历索引。</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014213412158.png" alt="image-20211014213412158"></p> <h3 id="复合索引"><a href="#复合索引" class="header-anchor">#</a> 复合索引</h3> <p>复合索引中列出的字段顺序具有重要意义。例如，如果复合索引由 { userid: 1, score:  -1 } 组成，则索引首先按userid正序排序，然后
在每个userid的值内，再在按score倒序排序。</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014213438408.png" alt="image-20211014213438408"></p> <h3 id="其他索引"><a href="#其他索引" class="header-anchor">#</a> 其他索引</h3> <ul><li><p>地理空间索引（Geospatial Index）
为了支持对地理空间坐标数据的有效查询，MongoDB提供了两种特殊的索引：返回结果时使用平面几何的二维索引和返回结果时使用球面
几何的二维球面索引。</p></li> <li><p>文本索引（Text Indexes）
MongoDB提供了一种文本索引类型，支持在集合中搜索字符串内容。这些文本索引不存储特定于语言的停止词（例如“the”、“a”、“or”），
而将集合中的词作为词干，只存储根词。</p></li> <li><p>哈希索引（Hashed Indexes）
为了支持基于散列的分片，MongoDB提供了散列索引类型，它对字段值的散列进行索引。这些索引在其范围内的值分布更加随机，但只支
持相等匹配，不支持基于范围的查询。</p></li></ul> <h3 id="索引管理"><a href="#索引管理" class="header-anchor">#</a> 索引管理</h3> <h4 id="查看索引"><a href="#查看索引" class="header-anchor">#</a> 查看索引</h4> <p>返回一个集合中的所有索引的数组   _id主键自带索引为升序</p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.comment.getIndexes<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="创建索引"><a href="#创建索引" class="header-anchor">#</a> 创建索引</h4> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014213916168.png" alt="image-20211014213916168"></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.collection.createIndex(keys, options)</span>
db.comment.createIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:1<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># 给userid创建索引 为升序 索引名默认为键名后加上_(1或者-1)</span>
db.comment.createIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:1,nickname:-1<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#复合索引</span>
</code></pre></div><h4 id="删除索引"><a href="#删除索引" class="header-anchor">#</a> 删除索引</h4> <p>如果要删除<strong>文本索引</strong>只能通过索引名删除</p> <p>_id索引无法删除</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.collection.dropIndex(索引名)</span>
db.comment.dropIndex<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#删除所有索引</span>
db.comment.dropIndex<span class="token punctuation">(</span><span class="token string">&quot;userid_1_nickname_-1&quot;</span><span class="token punctuation">)</span> <span class="token comment">#删除指定索引</span>
db.comment.dropIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:1<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#根据创建索引条件删除索引</span>
</code></pre></div><h3 id="索引的使用"><a href="#索引的使用" class="header-anchor">#</a> 索引的使用</h3> <p>分析查询性能（Analyze Query Performance）通常使用执行计划（解释计划、Explain Plan）来查看查询的情况，如查询耗费的时间、是否基于索引查询等。
那么，通常，我们想知道，建立的索引是否有效，效果如何，都需要通过执行计划查看。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.collection.find(query,options).explain(options)</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>uderid:<span class="token string">&quot;1003&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>.explain<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>关键点看： <code>&quot;stage&quot;</code> : <code>&quot;COLLSCAN&quot;</code>, 表示全集合扫描</p> <p>​					 <code>&quot;stage&quot;</code> : <code>&quot;IXSCAN&quot;</code> ,基于索引的扫描</p> <h3 id="涵盖查询"><a href="#涵盖查询" class="header-anchor">#</a> 涵盖查询</h3> <p>Covered Queries
当<strong>查询条件</strong>和<strong>查询的投影</strong>仅包含<strong>索引字段</strong>时，MongoDB直接从索引返回结果，而不扫描任何文档或将文档带入内存。 这些覆盖的查询可以非常有效。  其实就是查询符合查询条件 索引字段的值</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014232035127.png" alt="image-20211014232035127"></p> <h2 id="java连接mongodb"><a href="#java连接mongodb" class="header-anchor">#</a> Java连接MongoDB</h2> <ol><li>mongodb-driver  是mongo官方推出的java连接mongoDB的驱动包，相当于JDBC驱动。我们通过一个入门的案例来了解mongodb-driver
的基本使用。
官方驱动说明和下载： http://mongodb.github.io/mongo-java-driver/
官方驱动示例文档：http://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/</li> <li>SpringDataMongoDB  SpringData家族成员之一，用于操作MongoDB的持久层框架，封装了底层的mongodb-driver。
官网主页： https://projects.spring.io/spring-data-mongodb/</li></ol> <h2 id="评论案例"><a href="#评论案例" class="header-anchor">#</a> 评论案例</h2> <h3 id="模块搭建"><a href="#模块搭建" class="header-anchor">#</a> 模块搭建</h3> <ol><li>继承spring-boot项目 导入springdataMongoDB坐标</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-mongodb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li><p>创建application.yml</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.130.212  <span class="token comment"># 主机地址</span>
      <span class="token key atrule">database</span><span class="token punctuation">:</span> articledb  <span class="token comment"># 数据库</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span> <span class="token comment"># 默认端口是27017</span>
      <span class="token comment">#也可以使用uri连接</span>
      <span class="token comment">#uri: mongodb://192.168.40.134:27017/articledb</span>
</code></pre></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015131818984.png" alt="image-20211015131818984"></p></li></ol> <h3 id="实体类"><a href="#实体类" class="header-anchor">#</a> 实体类</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>po</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Id</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">CompoundIndex</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">Indexed</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span></span><span class="token class-name">Document</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 文章评论实体类
 */</span>
<span class="token comment">//把一个java类声明为mongodb的文档，可以通过collection参数指定这个类对应的文档。</span>
<span class="token comment">//@Document(collection=&quot;mongodb 对应 collection 名&quot;)</span>
<span class="token comment">// 若未加 @Document ，该 bean save 到 mongo 的 comment collection</span>
<span class="token comment">// 若添加 @Document ，则 save 到 comment collection</span>
<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>collection <span class="token operator">=</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">)</span><span class="token comment">//可以省略，如果省略，则默认使用类名小写映射集合 会映射到与类名一致的集合当中</span>
<span class="token comment">//复合索引</span>
<span class="token comment">// @CompoundIndex( def = &quot;{'userid': 1, 'nickname': -1}&quot;)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Comment</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">//主键标识，该属性的值会自动对应mongodb的主键字段&quot;_id&quot;，如果该属性名就叫“id”,则该注解可以省略，否则必须写</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span><span class="token comment">//主键</span>
    <span class="token comment">//该属性对应mongodb的字段的名字，如果一致，则无需该注解</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span><span class="token comment">//吐槽内容</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> publishtime<span class="token punctuation">;</span><span class="token comment">//发布日期</span>
    <span class="token comment">//添加了一个单字段的索引</span>
    <span class="token annotation punctuation">@Indexed</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userid<span class="token punctuation">;</span><span class="token comment">//发布人ID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span><span class="token comment">//昵称</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createdatetime<span class="token punctuation">;</span><span class="token comment">//评论的日期时间</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> likenum<span class="token punctuation">;</span><span class="token comment">//点赞数</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> replynum<span class="token punctuation">;</span><span class="token comment">//回复数</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> state<span class="token punctuation">;</span><span class="token comment">//状态</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> parentid<span class="token punctuation">;</span><span class="token comment">//上级ID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> articleid<span class="token punctuation">;</span>

    <span class="token comment">//getter and setter.....</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getPublishtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> publishtime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPublishtime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> publishtime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>publishtime <span class="token operator">=</span> publishtime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserid</span><span class="token punctuation">(</span><span class="token class-name">String</span> userid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userid <span class="token operator">=</span> userid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> nickname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token class-name">String</span> nickname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nickname <span class="token operator">=</span> nickname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">LocalDateTime</span> <span class="token function">getCreatedatetime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> createdatetime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCreatedatetime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span> createdatetime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>createdatetime <span class="token operator">=</span> createdatetime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getLikenum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> likenum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLikenum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> likenum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>likenum <span class="token operator">=</span> likenum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getReplynum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> replynum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReplynum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> replynum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>replynum <span class="token operator">=</span> replynum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">String</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getParentid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> parentid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setParentid</span><span class="token punctuation">(</span><span class="token class-name">String</span> parentid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parentid <span class="token operator">=</span> parentid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getArticleid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> articleid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setArticleid</span><span class="token punctuation">(</span><span class="token class-name">String</span> articleid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>articleid <span class="token operator">=</span> articleid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Comment{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;id='&quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, content='&quot;</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, publishtime=&quot;</span> <span class="token operator">+</span> publishtime <span class="token operator">+</span>
                <span class="token string">&quot;, userid='&quot;</span> <span class="token operator">+</span> userid <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, nickname='&quot;</span> <span class="token operator">+</span> nickname <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, createdatetime=&quot;</span> <span class="token operator">+</span> createdatetime <span class="token operator">+</span>
                <span class="token string">&quot;, likenum=&quot;</span> <span class="token operator">+</span> likenum <span class="token operator">+</span>
                <span class="token string">&quot;, replynum=&quot;</span> <span class="token operator">+</span> replynum <span class="token operator">+</span>
                <span class="token string">&quot;, state='&quot;</span> <span class="token operator">+</span> state <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, parentid='&quot;</span> <span class="token operator">+</span> parentid <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, articleid='&quot;</span> <span class="token operator">+</span> articleid <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li>@Document(collection = &quot;comment&quot;)   声明为mongodb文档 并且映射到comment集合中   如果当前实体类名与集合一致则collection可以忽略(并且只能是小写名称的实体类)</li> <li>@CompoundIndex( def = &quot;{'userid': 1, 'nickname': -1}&quot;)    复合索引 def属性与设置复活索引条件一致 为键和排序方式</li> <li>@Id   声明此属性为主键  如果属性名为id则该注解可以省略不加</li> <li>@Field(&quot;content&quot;)   当成员属性名称与集合中的键字段不一致时 可以使用该注解映射为集合中指定的键字段 此时映射为content键字段</li> <li>@Indexed  添加为单字段索引</li></ul> <h3 id="增删改查方法"><a href="#增删改查方法" class="header-anchor">#</a> 增删改查方法</h3> <ol><li><p>创建dao层接口 并继承MongoRepository 泛型为 实体类 和 id的类型</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dao</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">Comment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">MongoRepository</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CommentRepository</span> <span class="token keyword">extends</span> <span class="token class-name">MongoRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

</code></pre></div></li> <li><p>创建Service层 注入dao层 并调用动态代理里的方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">CommentRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">Comment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommentService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CommentRepository</span> commentRepository<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 保存一个评论
     *
     * @param comment
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveComment</span><span class="token punctuation">(</span><span class="token class-name">Comment</span> comment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果需要自定义主键，可以在这里指定主键；如果不指定主键，MongoDB会自动生成主键</span>
        <span class="token comment">//设置一些默认初始值。。。</span>
        <span class="token comment">//调用dao</span>
        commentRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 更新评论
     *
     * @param comment
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateComment</span><span class="token punctuation">(</span><span class="token class-name">Comment</span> comment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用dao</span>
        commentRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据id删除评论
     *
     * @param id
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteCommentById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用dao</span>
        commentRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询所有评论
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCommentList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用dao</span>
        <span class="token keyword">return</span> commentRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据id查询评论
     *
     * @param id
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Comment</span> <span class="token function">findCommentById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用dao</span>
        <span class="token keyword">return</span> commentRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="创建测试方法"><a href="#创建测试方法" class="header-anchor">#</a> 创建测试方法</h3> <ol><li><p>新建junit测试方法 类路径要与主程序一致</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">Comment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CommentService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommentServiceTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CommentService</span> commentService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFindCommentList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> commentList <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>commentList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFndCommentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Comment</span> commentById <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentById</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>commentById<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 保存一个评论
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSaveComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Comment</span> comment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//此处没有指定id 但MongoDB默认自动生成 我们推荐自动生成 不推荐自己书写id</span>
        comment<span class="token punctuation">.</span><span class="token function">setArticleid</span><span class="token punctuation">(</span><span class="token string">&quot;100000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token string">&quot;测试添加的数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setCreatedatetime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setUserid</span><span class="token punctuation">(</span><span class="token string">&quot;1003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;凯撒大帝&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setLikenum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setReplynum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        commentService<span class="token punctuation">.</span><span class="token function">saveComment</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="分页查询测试"><a href="#分页查询测试" class="header-anchor">#</a> 分页查询测试</h3> <ol><li><p>在dao层接口创建新的方法  必须要指定<strong>对应的属性名为方法名</strong>否则会报错</p> <p>格式: Page&lt;实体类&gt; findBy根据哪个属性来查询(传递属性类型 属性名,Pageable pageable);</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">////根据父id，查询子评论的分页列表</span>
<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByParentid</span><span class="token punctuation">(</span><span class="token class-name">String</span> parentid<span class="token punctuation">,</span> <span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>在service层调用dao层的方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
     * 分页查询
     *
     * @param parentid 根据哪个属性来查询
     * @param page     页码
     * @param size     每页个数
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCommentListByParentid</span><span class="token punctuation">(</span><span class="token class-name">String</span> parentid<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> commentRepository<span class="token punctuation">.</span><span class="token function">findByParentid</span><span class="token punctuation">(</span>parentid<span class="token punctuation">,</span> <span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>测试用例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFindCommentListByParentid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentListByParentid</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getTotalElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回总条数</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> content <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//返回结果的集合</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="评论点赞"><a href="#评论点赞" class="header-anchor">#</a> 评论点赞</h3> <p>最简单的方法就是根据id查询当前对应的文档 并将点赞数+1  但执行效率不高 因为只需要修改点赞数 没有必要把所有的字段都查询出来</p> <p>我们可以使用 MongoTemplate 类实现对某列进行操作</p> <ol><li><p>在service层注入 MongoTemplate  并编修改方法</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 点赞数+1
     *
     * @param id
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCommentLikenum</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//查询条件</span>
        <span class="token comment">//Query query = Query.query(Criteria.where(&quot;_id&quot;).is(id)).addCriteria(Criteria.where(&quot;nickname&quot;).is(&quot;凯撒大帝&quot;));  //使用Criteria.when(键字段).is(条件)  判断条件 addCriteria可以无限扩展条件</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新条件</span>
        <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        update<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token string">&quot;likenum&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将likenum数+1  如单传键字段则自动加1</span>
<span class="token comment">//        update.set()</span>

        mongoTemplate<span class="token punctuation">.</span><span class="token function">updateFirst</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> update<span class="token punctuation">,</span> <span class="token class-name">Comment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div></li></ol> <h2 id="副本集"><a href="#副本集" class="header-anchor">#</a> 副本集</h2> <p>MongoDB中的副本集（Replica Set）是一组维护相同数据集的mongod服务。 副本集可提供冗余和高
可用性，是所有生产部署的基础。</p> <p>主从复制和副本集区别
主从集群和副本集最大的区别就是副本集没有固定的“主节点”；整个集群会选出一个“主节点”，当其挂
掉后，又在剩下的从节点中选中其他节点为“主节点”，副本集总有一个活跃点(主、primary)和一个或多
个备份节点(从、secondary)。</p> <p>副本集有两种类型三种角色:</p> <p>两种类型：</p> <ul><li>主节点（ Primary）类型：数据操作的主要连接点，可读写。</li> <li>次要（辅助、从）节点（ Secondaries）类型：数据冗余备份节点，可以读或选举。</li></ul> <p>三种角色：</p> <ul><li>主要成员（Primary）：主要接收所有写操作。就是主节点。</li> <li>副本成员（Replicate）：从主节点通过复制操作以维护相同的数据集，即备份数据，不可写操作，但可
以读操作（但需要配置）。是默认的一种从节点类型。</li> <li>仲裁者（ Arbiter）：不保留任何数据的副本，只具有投票选举作用。当然也可以将仲裁服务器维护为副
本集的一部分，即副本成员同时也可以是仲裁者。也是一种从节点类型。</li></ul> <h3 id="副本集创建"><a href="#副本集创建" class="header-anchor">#</a> 副本集创建</h3> <h4 id="主节点"><a href="#主节点" class="header-anchor">#</a> 主节点</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#主节点</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27017/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span> <span class="token comment">#日志文件</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27017/data/db <span class="token comment">#数据文件</span>

<span class="token function">vim</span> /mongodb/replica_sets/myrs_27017/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27017/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27017/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27017/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token comment">#副本集的名称  同一个副本集中集群必须一致</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myrs
</code></pre></div><p>启动主节点</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27017/mongod.conf
</code></pre></div><h4 id="从节点"><a href="#从节点" class="header-anchor">#</a> 从节点</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#副本节点</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27018/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27018/data/db
<span class="token function">vim</span> /mongodb/replica_sets/myrs_27018/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27018/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27018/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27018/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27018</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token comment">#副本集的名称</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myrs
</code></pre></div><p>启动节点</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27018/mongod.conf
</code></pre></div><h4 id="仲裁节点"><a href="#仲裁节点" class="header-anchor">#</a> 仲裁节点</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#仲裁节点</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27019/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27019/data/db
<span class="token function">vim</span> /mongodb/replica_sets/myrs_27019/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 destination<span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 path<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27019/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 logAppend<span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 dbPath<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27019/data/db&quot;</span>
 journal<span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  enabled<span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 fork<span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 pidFilePath<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27019/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 bindIp<span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 port<span class="token punctuation">:</span> <span class="token number">27019</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token comment">#副本集的名称</span>
 replSetName<span class="token punctuation">:</span> myrs
</code></pre></div><p>启动节点</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27019/mongod.conf
</code></pre></div><h3 id="初始化配置副本集和主节点"><a href="#初始化配置副本集和主节点" class="header-anchor">#</a> 初始化配置副本集和主节点</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#使用mongo客户端任意节点都可以 但尽量连上主节点</span>
/usr/local/mongodb/bin/mongo --host<span class="token operator">=</span><span class="token number">192.168</span>.130.212 --port<span class="token operator">=</span><span class="token number">27017</span>

<span class="token comment">#初始化命令</span>
rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#使用默认的配置来初始化副本集  “ok”的值为1，说明创建成功  并且此节点变为主节点</span>

rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看默认节点配置</span>

rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 查询副本集状态</span>
</code></pre></div><h3 id="添加副本从节点"><a href="#添加副本从节点" class="header-anchor">#</a> 添加副本从节点</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#rs.add(host:post)</span>
rs.add<span class="token punctuation">(</span><span class="token number">192.168</span>.130.212:27018<span class="token punctuation">)</span>

rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看副本集状态</span>
</code></pre></div><h3 id="添加仲裁节点"><a href="#添加仲裁节点" class="header-anchor">#</a> 添加仲裁节点</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#rs.addArb(host:post)</span>
rs.addarB<span class="token punctuation">(</span><span class="token number">192.168</span>.130.212:27019<span class="token punctuation">)</span>

rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看副本集状态</span>
</code></pre></div><h3 id="副本集的数据读写操作"><a href="#副本集的数据读写操作" class="header-anchor">#</a> 副本集的数据读写操作</h3> <ol><li><p>只有主节点写入数据和读取数据</p></li> <li><p>默认情况从节点无法读取数据 也无法写入数据  可以进行设置增加读的权限</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#连接从节点的客户端</span>
rs.slaveOk<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#该命令是 db.getMongo().setSlaveOk() 的简化命令</span>
<span class="token comment">#或者</span>
rs.slaveOk<span class="token punctuation">(</span>true<span class="token punctuation">)</span> 
<span class="token comment">#此时实现了读写分离 让主插入数据 让从来读取数据</span>
</code></pre></div></li> <li><p>仲裁者节点，不存放任何业务数据的，可以登录查看 只存放副本集配置等数据。</p></li></ol> <h3 id="主节点的选举原则"><a href="#主节点的选举原则" class="header-anchor">#</a> 主节点的选举原则</h3> <p>MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件：</p> <ol><li>主节点故障</li> <li>主节点网络不可达（默认心跳信息为10秒）</li> <li>人工干预（rs.stepDown(600)）</li></ol> <p>选举规则是根据票数来决定谁获胜：</p> <ul><li>票数最高，且获得了 “大多数”成员的投票支持的节点获胜。
“大多数”的定义为：假设复制集内投票成员数量为N，则大多数为 N/2 + 1。例如：3个投票成员，
则大多数的值是2。当复制集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，
复制集将无法提供写服务，处于只读状态。</li> <li>若票数相同，且都获得了 “大多数”成员的投票支持的，数据新的节点获胜。
数据的新旧是通过操作日志oplog来对比的。</li></ul> <p>在获得票数的时候，优先级（priority）参数影响重大。
可以通过设置优先级（priority）来设置额外票数。优先级即权重，取值为0-1000，相当于可额外增加
0-1000的票数，优先级的值越大，就越可能获得多数成员的投票（votes）数。指定较高的值可使成员
更有资格成为主要成员，更低的值可使成员更不符合条件。
默认情况下，优先级的值是1</p> <h3 id="提升优先级"><a href="#提升优先级" class="header-anchor">#</a> 提升优先级</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#先导出配置到变量中</span>
<span class="token assign-left variable">cfg</span><span class="token operator">=</span>rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#修改指定优先级  ID号默认从0开始</span>
cfg.members<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>.priority<span class="token operator">=</span><span class="token number">2</span>
<span class="token comment">#重新加载配置</span>
rs.reconfig<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
</code></pre></div><h3 id="compass连接副本集"><a href="#compass连接副本集" class="header-anchor">#</a> Compass连接副本集</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#将host修改为当前主节点的ip</span>
var config <span class="token operator">=</span> rs.config<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 config.members<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.host<span class="token operator">=</span><span class="token string">&quot;192.168.130.212:27017&quot;</span><span class="token punctuation">;</span>rs.reconfig<span class="token punctuation">(</span>config<span class="token punctuation">)</span> 
</code></pre></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015155651742.png" alt="image-20211015155651742"></p> <p>选择Primary 为主节点   Secondary为副本集</p> <h3 id="springdatamongodb连接副本集"><a href="#springdatamongodb连接副本集" class="header-anchor">#</a> SpringDataMongoDB连接副本集</h3> <p>mongodb://host1,host2,host3/articledb?connect=replicaSet&amp;slaveOk=true&amp;replicaSet=副本集名字</p> <ul><li>slaveOk=true ：开启副本节点读的功能，可实现读写分离。</li> <li>connect=replicaSet ：自动到副本集中选择读写的主机。如果slaveOK是打开的，则实现了读写分
离</li></ul> <p>主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>spring:
  data:
    mongodb:
      <span class="token comment"># host: 192.168.130.212  # 主机地址</span>
      <span class="token comment"># database: articledb  # 数据库</span>
      <span class="token comment"># port: 27017 # 默认端口是27017</span>
      <span class="token comment">#也可以使用uri连接</span>
      <span class="token comment">#uri: mongodb://192.168.40.134:27017/articledb</span>
        <span class="token comment"># 副本集的连接字符串</span>
      uri: mongodb://192.168.42.212:27017,192.168.42.212:27018,192.168.42.212:27019/article
      db?connect<span class="token operator">=</span>replicaSet<span class="token operator">&amp;</span><span class="token assign-left variable">slaveOk</span><span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">replicaSet</span><span class="token operator">=</span>myrs
</code></pre></div><h2 id="分片集群"><a href="#分片集群" class="header-anchor">#</a> 分片集群</h2> <p>分片（sharding）是一种跨多台机器分布数据的方法， MongoDB使用分片来支持具有非常大的数据集
和高吞吐量操作的部署。</p> <p>MongoDB分片群集包含以下组件：</p> <ul><li>分片（存储）：每个分片包含分片数据的子集。 每个分片都可以部署为副本集。</li> <li>mongos （路由）：mongos充当查询路由器，在客户端应用程序和分片集群之间提供接口。</li> <li>config servers （“调度”的配置）：配置服务器存储群集的元数据和配置设置。 从MongoDB 3.4开
始，必须将配置服务器部署为副本集（CSRS）。</li></ul> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015160418466.png" alt="image-20211015160418466"></p> <h3 id="搭建分片集群架构"><a href="#搭建分片集群架构" class="header-anchor">#</a> 搭建分片集群架构</h3> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015160552667.png" alt="image-20211015160552667"></p> <h4 id="第一个副本集"><a href="#第一个副本集" class="header-anchor">#</a> 第一个副本集</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#-----------myshardrs01</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27018/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27018/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27118/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27118/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27218/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27218/data/db

<span class="token comment">#myshardrs01_27018</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27018/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27018</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token comment">#副本集的名称</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs01
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token comment">#分片角色</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre></div><p>clusterRole 设置分片角色:</p> <ul><li>shardsvr  分片角色</li> <li>configsvr 配置角色</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#myshardrs01_27118</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27118/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27118</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs01
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#myshardrs01_27218</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27218/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.42.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27218</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs01
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre></div><p>启动第一套副本集：一主一副本一仲裁</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf
</code></pre></div><ul><li>初始化副本集和创建主节点</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongo --host <span class="token number">192.168</span>.130.212 --port <span class="token number">27018</span> <span class="token comment">#尽量连接主节点</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#初始化主节点</span>
rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#状态查看</span>
rs.add<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27118&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#添加副节点</span>
rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27218&quot;</span><span class="token punctuation">)</span> <span class="token comment">#添加仲裁节点</span>
rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="第二套副本集"><a href="#第二套副本集" class="header-anchor">#</a> 第二套副本集</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#-----------myshardrs02</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27318/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27318/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27418/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27418/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27518/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27518/data/db
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#myshardrs02_27318</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27318/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27318/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27318/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27318</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs02
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#myshardrs02_27418</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27418/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27418/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27418/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27418</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs02
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#myshardrs02_27518</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 destination<span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 path<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27518/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 logAppend<span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 dbPath<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27518/data/db&quot;</span>
 journal<span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  enabled<span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 fork<span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 pidFilePath<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27518/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 bindIp<span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 port<span class="token punctuation">:</span> <span class="token number">27518</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 replSetName<span class="token punctuation">:</span> myshardrs02
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 clusterRole<span class="token punctuation">:</span> shardsvr
</code></pre></div><p>启动第二套副本集：一主一副本一仲裁</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf
<span class="token function">ps</span> -ef <span class="token operator">|</span><span class="token function">grep</span> mongod <span class="token comment">#一共6个服务</span>
</code></pre></div><ul><li>初始化副本集和创建主节点</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongo --host <span class="token number">192.168</span>.130.212 --port <span class="token number">27318</span> <span class="token comment">#尽量连接主节点</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#初始化主节点</span>
rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#状态查看</span>
rs.add<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27418&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#添加副节点</span>
rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27518&quot;</span><span class="token punctuation">)</span> <span class="token comment">#添加仲裁节点</span>
rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="配置节点副本集"><a href="#配置节点副本集" class="header-anchor">#</a> 配置节点副本集</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#-----------configrs</span>
<span class="token comment">#建立数据节点data和日志目录</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27019/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27019/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27119/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27119/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27219/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27219/data/db
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#myconfigrs_27019</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code> <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27019/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27019/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27019/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27019</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myconfigrs
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> configsvr
</code></pre></div><p>此时分片角色为配置角色</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#myconfigrs_27119</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27119/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27119/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27119/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27119</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myconfigrs
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> configsvr
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#myconfigrs_27219</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27219/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27219/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27219/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.42.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27219</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myconfigrs
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> configsvr
</code></pre></div><p>启动配置副本集：一主两副本</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf
<span class="token function">ps</span> -ef <span class="token operator">|</span><span class="token function">grep</span> mongod <span class="token comment">#一共9个服务</span>
</code></pre></div><ul><li>初始化副本集和创建主节点</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongo --host <span class="token number">192.168</span>.130.212 --port <span class="token number">27019</span> <span class="token comment">#尽量连接主节点</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#初始化主节点</span>
rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#状态查看</span>
rs.add<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27119&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#添加副节点</span>
rs.add<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27119&quot;</span><span class="token punctuation">)</span> <span class="token comment">#添加副节点</span>
rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="路由节点创建和连接"><a href="#路由节点创建和连接" class="header-anchor">#</a> 路由节点创建和连接</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#-----------mongos01</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/mymongos_27017/log
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#mymongos_27017节点</span>
<span class="token function">vi</span> /mongodb/sharded_cluster/mymongos_27017/mongos.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/mymongos_27017/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> /mongodb/sharded_cluster/mymongos_27017/log/mongod.pid&quot;
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token comment">#指定配置节点副本集</span>
 <span class="token key atrule">configDB</span><span class="token punctuation">:</span> myconfigrs/192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27019</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27119</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27219</span>
</code></pre></div><p>configDB 地址为 配置副本集名称/配置节点1,配置节点2,配置节点3</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#启动</span>
/usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27017/mongos.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#连接 此时为mongos</span>
/usr/local/mongodb/bin/mongo --host <span class="token number">192.168</span>.130.212 --port <span class="token number">27017</span>
</code></pre></div><p>通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此写不进去数据，如果写数据会报错。</p> <h4 id="路由节点添加分片"><a href="#路由节点添加分片" class="header-anchor">#</a> 路由节点添加分片</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#sh.addShard(副本集名称/主节点,副本节点,仲裁节点)  三种角色节点必须都添加到路由中 </span>
sh.addShard<span class="token punctuation">(</span><span class="token string">&quot;myshardrs01/192.168.42.130.212:27018,192.168.42.130.212:27118,192.168.42.130.212:27218&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#第一套</span>
sh.addShard<span class="token punctuation">(</span><span class="token string">&quot;myshardrs02/192.168.42.130.212:27318,192.168.42.130.212:27418,192.168.42.130.212:27518&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#第二套</span>
sh.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查询分片状态</span>
<span class="token comment">#sh.enableSharding(&quot;库名&quot;)</span>
sh.enableSharding<span class="token punctuation">(</span><span class="token string">&quot;articledb&quot;</span><span class="token punctuation">)</span> <span class="token comment">#开启分片功能</span>
</code></pre></div><h5 id="集合分片和分片规则"><a href="#集合分片和分片规则" class="header-anchor">#</a> 集合分片和分片规则</h5> <p>sh.shardCollection(namespace, key, unique)</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015165012819.png" alt="image-20211015165012819"></p> <ol><li><p>分片规则一：哈希策略
对指定字段的值 进行哈希计算出存放的位置  每个副本集对应则对应的范围 通过哈希计算出存放的副本集中</p> <div class="language-sh extra-class"><pre class="language-sh"><code>sh.shardCollection<span class="token punctuation">(</span><span class="token string">&quot;articledb.comment&quot;</span>,<span class="token punctuation">{</span><span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;hashed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>分片规则二：范围策略
对于 基于范围的分片 ,MongoDB按键的范围把数据分成不同部分.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>sh.shardCollection<span class="token punctuation">(</span><span class="token string">&quot;articledb.author&quot;</span>,<span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span>:1<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ol> <p>注意事项:</p> <ul><li>一个集合只能指定一个片键，否则报错。</li> <li>一旦对一个集合分片，分片键和分片值就不可改变。 如：不能给集合选择不同的分片键、不能更新
分片键的值。</li> <li>根据age索引进行分配数据</li></ul> <p>如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>use admin
db.runCommand<span class="token punctuation">(</span> <span class="token punctuation">{</span> removeShard: <span class="token string">&quot;myshardrs02&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>db.printShardingStatus<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#显示集群的详细信息</span>
sh.isBalancerRunning<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#查询交换器是否工作</span>
sh.getBalancerState<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看Balancer状态 </span>
</code></pre></div><h5 id="范围规则配置数据块大小"><a href="#范围规则配置数据块大小" class="header-anchor">#</a> 范围规则配置数据块大小</h5> <p>范围规则默认存放在数据块中 如果数据块（chunk）没有填满，默认的数据块尺寸（chunksize）是64M，填满后才会考虑向其他片的数据块填充数据</p> <div class="language-sh extra-class"><pre class="language-sh"><code>use config
db.settings.save<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;chunksize&quot;</span>, value: <span class="token number">64</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#默认为64m</span>
</code></pre></div><h4 id="追加路由节点"><a href="#追加路由节点" class="header-anchor">#</a> 追加路由节点</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#-----------mongos02</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/mymongos_27117/log
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vi</span> /mongodb/sharded_cluster/mymongos_27117/mongos.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/mymongos_27117/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> /mongodb/sharded_cluster/mymongos_27117/log/mongod.pid&quot;
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.0.2
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27117</span>
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
<span class="token key atrule">configDB</span><span class="token punctuation">:</span>
myconfigrs/192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27019</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27119</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27219</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#启动</span>
/usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27117/mongos.conf
</code></pre></div><p>第二个路由无需配置，因为分片配置都保存到了配置服务器中了。</p> <h3 id="compass连接分片集群"><a href="#compass连接分片集群" class="header-anchor">#</a> Compass连接分片集群</h3> <p>连接路由节点即可</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015183225341.png" alt="image-20211015183225341"></p> <h3 id="springdatamongdb-连接分片集群"><a href="#springdatamongdb-连接分片集群" class="header-anchor">#</a> SpringDataMongDB 连接分片集群</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
      <span class="token comment"># host: 192.168.130.212  # 主机地址</span>
      <span class="token comment"># database: articledb  # 数据库</span>
      <span class="token comment"># port: 27017 # 默认端口是27017</span>
        <span class="token comment">#也可以使用uri连接</span>
        <span class="token comment">#uri: mongodb://192.168.40.134:27017/articledb</span>
      <span class="token comment"># 副本集的连接字符串</span>
            <span class="token key atrule">uri</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">:</span>//192.168.40.134<span class="token punctuation">:</span><span class="token number">27017</span><span class="token punctuation">,</span>192.168.40.134<span class="token punctuation">:</span>27117/articledb

<span class="token comment">#      uri: mongodb://192.168.42.212:27017,192.168.42.212:27018,192.168.42.212:27019/article</span>
<span class="token comment">#      db?connect=replicaSet&amp;slaveOk=true&amp;replicaSet=myrs</span>
</code></pre></div><p>如果有多个节点可以使用逗号隔开 SpringDataMongDB默认有负载均衡策略</p> <h2 id="安全认证"><a href="#安全认证" class="header-anchor">#</a> 安全认证</h2> <p>默认情况下，MongoDB实例启动运行时是没有启用用户访问权限控制的</p> <h3 id="角色"><a href="#角色" class="header-anchor">#</a> 角色</h3> <p>常用的内置角色：</p> <ul><li>数据库用户角色： read、readWrite;</li> <li>所有数据库用户角色： readAnyDatabase、readWriteAnyDatabase、</li> <li>userAdminAnyDatabase、dbAdminAnyDatabase</li> <li>数据库管理角色： dbAdmin、dbOwner、userAdmin；</li> <li>集群管理角色： clusterAdmin、clusterManager、clusterMonitor、hostManager；</li> <li>备份恢复角色： backup、restore；</li> <li>超级用户角色： root</li> <li>内部角色： system</li></ul> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015183741098.png" alt="image-20211015183741098"></p> <div class="language-sh extra-class"><pre class="language-sh"><code>db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> rolesInfo: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#查询所有角色权限(仅用户自定义角色)</span>
db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> rolesInfo: <span class="token number">1</span>, showBuiltinRoles: <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#查询所有角色权限(包含内置角色)</span>
db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> rolesInfo: <span class="token string">&quot;&lt;rolename&gt;&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#查询当前数据库中的某角色的权限</span>
db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> rolesInfo: <span class="token punctuation">{</span> role: <span class="token string">&quot;&lt;rolename&gt;&quot;</span>, db: <span class="token string">&quot;&lt;database&gt;&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>   <span class="token comment">#查询其它数据库中指定的角色权限</span>
</code></pre></div><h3 id="单实例安全认证"><a href="#单实例安全认证" class="header-anchor">#</a> 单实例安全认证</h3> <ul><li>添加用户和权限</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>use admin
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;myroot&quot;</span>,pwd:<span class="token string">&quot;123456&quot;</span>,roles:<span class="token punctuation">[</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#创建myroot用户 密码123456 权限为root  如果不指定db名称则默认为当前所在库</span>
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;myadmin&quot;</span>,pwd:<span class="token string">&quot;123456&quot;</span>,roles:<span class="token punctuation">[</span><span class="token punctuation">{</span>role:<span class="token string">&quot;userAdminAnyDatabase&quot;</span>,db:<span class="token string">&quot;admin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#创建一个在指定库中管理用户的用户</span>
db.system.users.find<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#查询已经创建的用户情况</span>
db.dropUser<span class="token punctuation">(</span><span class="token string">&quot;myadmin&quot;</span><span class="token punctuation">)</span> <span class="token comment">#删除指定用户</span>
db.changeUserPassword<span class="token punctuation">(</span><span class="token string">&quot;myroot&quot;</span>, <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#修改指定用户密码</span>

</code></pre></div><ol><li>本案例创建了两个用户，分别对应超管和专门用来管理用户的角色，事实上，你只需要一个用户即
可。如果你对安全要求很高，防止超管泄漏，则不要创建超管用户。</li> <li>和其它数据库（MySQL）一样，权限的管理都差不多一样，也是将用户和权限信息保存到数据库对
应的表中。Mongodb存储所有的用户信息在admin 数据库的集合system.users中，保存用户名、密码
和数据库信息。</li> <li>如果不指定数据库，则创建的指定的权限的用户在所有的数据库上有效，如 <code>{role:&quot;userAdminAnyDatabase&quot;, db:&quot;&quot;}</code></li></ol> <ul><li>认证测试</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>use admin
db.auth<span class="token punctuation">(</span><span class="token string">&quot;myroot&quot;</span>,<span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>如果开启了认证后，登录的客户端的用户必须使用admin库的角色，如拥有root角色的myadmin用
户，再通过myadmin用户去创建其他角色的用户</p> <h4 id="服务端开启认证和客户端连接登陆"><a href="#服务端开启认证和客户端连接登陆" class="header-anchor">#</a> 服务端开启认证和客户端连接登陆</h4> <ol><li><p>参数方式  启动服务端时加锁--auth参数</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf --auth
</code></pre></div></li> <li><p>配置方式</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> /mongodb/single/mongod.conf

<span class="token comment">#配置文件追加</span>
security:
 authorization: enabled  <span class="token comment">#开启授权认证</span>
</code></pre></div></li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#此时连接可以进入客户端 但无法执行任何操作 只有认证成功后能使用</span>
use admin  <span class="token comment">#此用户能查看什么库就切换到什么库中再认证  否则报错</span>
db.auth<span class="token punctuation">(</span><span class="token string">&quot;myroot&quot;</span>,<span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>连接客户端时直接认证  同样查看什么库就切换到什么库中再认证  否则报错</p> <div class="language-sh extra-class"><pre class="language-sh"><code>mongo --host <span class="token number">192.168</span>.42.130.212 --port <span class="token number">27017</span> --authenticationDatabase admin -u myroot -p <span class="token number">123456</span>
</code></pre></div><ul><li>-u ：用户名</li> <li>-p ：密码</li> <li>-- authenticationDatabase ：指定连接到哪个库。当登录是指定用户名密码时，必须指定对应的
数据库！</li></ul> <h4 id="springdatamongodb连接认证"><a href="#springdatamongodb连接认证" class="header-anchor">#</a> SpringDataMongoDB连接认证</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
 <span class="token comment">#数据源配置</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
 <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
   <span class="token comment"># 主机地址</span>
<span class="token comment">#   host: 192.168.42.130.212</span>
   <span class="token comment"># 数据库</span>
<span class="token comment">#   database: articledb</span>
   <span class="token comment"># 默认端口是27017</span>
<span class="token comment">#   port: 27017</span>
   <span class="token comment">#帐号</span>
<span class="token comment">#   username: bobo</span>
   <span class="token comment">#密码</span>
<span class="token comment">#   password: 123456</span>
   <span class="token comment">#单机有认证的情况下，也使用字符串连接</span>
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">:</span>//bobo<span class="token punctuation">:</span>123456@192.168.130.212/articledb
</code></pre></div><h3 id="副本集环境"><a href="#副本集环境" class="header-anchor">#</a> 副本集环境</h3> <p>只需要在主节点上添加用户，副本集会自动同步</p> <div class="language-sh extra-class"><pre class="language-sh"><code>use admin
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;myroot&quot;</span>,pwd:<span class="token string">&quot;123456&quot;</span>,roles:<span class="token punctuation">[</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>生成副本集认证的key文件 在centos中</p> <div class="language-sh extra-class"><pre class="language-sh"><code>openssl rand -base64 <span class="token number">90</span> -out ./mongo.keyfile
<span class="token function">chmod</span> <span class="token number">400</span> ./mongo.keyfile
ll mongo.keyfile
</code></pre></div><p>所有副本集节点都必须要用同一份keyfile，一般是在一台机器上生成，然后拷贝到其他机器上，且必须
有读的权限，否则将来会报错</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#此时应该通过网络传输此key文件给集群机器</span>
<span class="token function">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27017
<span class="token function">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27018
<span class="token function">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27019
</code></pre></div><p>修改各个节点的配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> /mongodb/replica_sets/myrs_27017/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
 <span class="token comment">#KeyFile鉴权文件</span>
 <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27017/mongo.keyfile
 <span class="token comment">#开启认证方式运行</span>
 <span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> /mongodb/replica_sets/myrs_27018/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
 <span class="token comment">#KeyFile鉴权文件</span>
 <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27018/mongo.keyfile
 <span class="token comment">#开启认证方式运行</span>
 <span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> /mongodb/replica_sets/myrs_27019/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
 <span class="token comment">#KeyFile鉴权文件</span>
 <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27019/mongo.keyfile
 <span class="token comment">#开启认证方式运行</span>
 <span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled
</code></pre></div><p>重新启动</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27017/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27018/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27019/mongod.conf
</code></pre></div><p>创建新的用户读和写</p> <div class="language-sh extra-class"><pre class="language-sh"><code>mongo
use admin
db.auth<span class="token punctuation">(</span><span class="token string">&quot;myroot&quot;</span>,<span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span> <span class="token comment">#先登陆认证管理员账号</span>
use articledb
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user: <span class="token string">&quot;bobo&quot;</span>, pwd: <span class="token string">&quot;123456&quot;</span>, roles: <span class="token punctuation">[</span><span class="token string">&quot;readWrite&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="springdatamongodb连接副本集-2"><a href="#springdatamongodb连接副本集-2" class="header-anchor">#</a> SpringDataMongoDB连接副本集</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
 <span class="token comment">#数据源配置</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
 <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
   <span class="token comment">#副本集有认证的情况下，字符串连接</span>
  <span class="token key atrule">uri</span><span class="token punctuation">:</span>
mongodb<span class="token punctuation">:</span>//bobo<span class="token punctuation">:</span>123456@192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27017</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27018</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span>27019/articledb<span class="token punctuation">?</span>connect=replicaSet<span class="token important">&amp;slaveOk=true&amp;replicaSet=myrs</span>
</code></pre></div><h3 id="分片集群环境"><a href="#分片集群环境" class="header-anchor">#</a> 分片集群环境</h3> <p>关闭配置服务器副本集的服务，建议依次关闭副本节点、主节点再关闭路由服务器的服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.stepDown<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#告知副本集说本机要下线</span>
use admin 
db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ol><li>生成key文件</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code>openssl rand -base64 <span class="token number">90</span> -out ./mongo.keyfile
<span class="token function">chmod</span> <span class="token number">400</span> ./mongo.keyfile
</code></pre></div><ol start="2"><li><p>拷贝key文件到各个服务上</p></li> <li><p>修改配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#这里是各个服务上的配置文件</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
 <span class="token comment">#KeyFile鉴权文件 注意要修改路径</span>
 <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27019/mongo.keyfile
 <span class="token comment">#开启认证方式运行</span>
 <span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled
</code></pre></div></li> <li><p>重新启动各个节点</p> <p>先启动配置节点，再启动分片节点，最后启动路由节点。如果先启动分片节点，会卡住</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf
</code></pre></div></li> <li><p>客户端mongo，通过localhost登录任意一个mongos路由</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongo --port <span class="token number">27017</span>
</code></pre></div></li> <li><p>创建账号</p> <div class="language-sh extra-class"><pre class="language-sh"><code>use admin
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;myroot&quot;</span>,pwd:<span class="token string">&quot;123456&quot;</span>,roles:<span class="token punctuation">[</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#管理员账号</span>
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user: <span class="token string">&quot;bobo&quot;</span>, pwd: <span class="token string">&quot;123456&quot;</span>, roles: <span class="token punctuation">[</span><span class="token punctuation">{</span> role: <span class="token string">&quot;readWrite&quot;</span>,db: <span class="token string">&quot;articledb&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#指定库读写账号</span>
</code></pre></div></li></ol> <h4 id="springdatamongodb连接认证-2"><a href="#springdatamongodb连接认证-2" class="header-anchor">#</a> SpringDataMongoDB连接认证</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
 <span class="token comment">#数据源配置</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
 <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
   <span class="token comment"># 分片集群有认证的情况下，字符串连接</span>
  <span class="token key atrule">uri</span><span class="token punctuation">:</span>
mongodb<span class="token punctuation">:</span>//bobo<span class="token punctuation">:</span>123456@192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27017</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span>27117/articledb
</code></pre></div><h2 id="_4-0新特性"><a href="#_4-0新特性" class="header-anchor">#</a> 4.0新特性</h2> <h3 id="加载外部js文件"><a href="#加载外部js文件" class="header-anchor">#</a> 加载外部js文件</h3> <p>加载当前路径下的js文件 启动shell命令时的路径和js所在路径要一致</p> <div class="language-sh extra-class"><pre class="language-sh"><code>load<span class="token punctuation">(</span><span class="token string">&quot;aaa.js&quot;</span><span class="token punctuation">)</span> <span class="token comment">#返回true则成功</span>
</code></pre></div><h3 id="事务性"><a href="#事务性" class="header-anchor">#</a> 事务性</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>sh<span class="token punctuation">.</span>demo_01</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span></span><span class="token class-name">MongoClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span></span><span class="token class-name">ServerAddress</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>client<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Filters</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>bson<span class="token punctuation">.</span></span><span class="token class-name">Document</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>client<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Filters</span><span class="token punctuation">.</span>eq<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>client<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Updates</span><span class="token punctuation">.</span>inc<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo02</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">MongoClient</span> mongoClient<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">MongoDatabase</span> mongoDatabase<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">MongoCollection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> collection<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token comment">/////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
        <span class="token comment">//副本集</span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerAddress</span><span class="token punctuation">&gt;</span></span> servers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerAddress</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        servers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">27000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        servers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">27001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        servers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">27002</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mongoClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 连接到数据库 itcast表示数据库名</span>
        mongoDatabase <span class="token operator">=</span> mongoClient<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;itcast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//打印数据库最开始的状态</span>
        <span class="token function">printDataState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//转账 带事务的</span>
        <span class="token function">transerTransacFunds</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//带事务的转账</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">transerTransacFunds</span><span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;------------使用事务------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a向b转账100元，有可能会发生异常，回到之前的状态。两个人的操作在同一个事务中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-------------------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获取session</span>
        <span class="token class-name">ClientSession</span> session <span class="token operator">=</span> mongoClient<span class="token punctuation">.</span><span class="token function">startSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//开启事务</span>
            session<span class="token punctuation">.</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//a减100</span>
            <span class="token function">minusTransacFromA</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> a<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//模拟异常</span>
            <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">//b加100</span>
            <span class="token function">addTransacToB</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> b<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//提交事务</span>
            session<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;带事务，转账失败，回到开启事务之前的状态&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//回滚事务</span>
            session<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//关闭session</span>
            session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//输出账户状态</span>
            <span class="token function">printDataState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//带事务b加100</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addTransacToB</span><span class="token punctuation">(</span><span class="token class-name">ClientSession</span> session<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;b账户增加100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新文档   将文档中likes=100的文档修改为likes=200</span>
        collection<span class="token punctuation">.</span><span class="token function">updateMany</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token class-name">Filters</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//带事务a减100</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">minusTransacFromA</span><span class="token punctuation">(</span><span class="token class-name">ClientSession</span> session<span class="token punctuation">,</span> <span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a账户减少100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//inc 表示累加函数</span>
        collection<span class="token punctuation">.</span><span class="token function">updateMany</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token class-name">Filters</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span>money<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printDataState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//persons表示itcast数据库中的集合名</span>
        collection <span class="token operator">=</span> mongoDatabase<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;数据库中的起始状态：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//检索所有文档</span>
        <span class="token comment">/**
         * 1. 获取迭代器FindIterable&lt;Document&gt;
         * 2. 获取游标MongoCursor&lt;Document&gt;
         * 3. 通过游标遍历检索出的文档集合
         * */</span>
        <span class="token comment">//1. 获取迭代器FindIterable&lt;Document&gt;</span>
        <span class="token class-name">FindIterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> findIterable <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 获取游标MongoCursor&lt;Document&gt;</span>
        <span class="token class-name">MongoCursor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> mongoCursor <span class="token operator">=</span> findIterable<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3. 通过游标遍历检索出的文档集合</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>mongoCursor<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>mongoCursor<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="聚合数据类型转换"><a href="#聚合数据类型转换" class="header-anchor">#</a> 聚合数据类型转换</h3> <p>https://www.runoob.com/mongodb/mongodb-replication.html</p> <p>MongoDB4.0增加了一个新的聚合操作符：<strong>$convert</strong>,用来进行数据类型的转换。这个类型转换操作符简化了数据的抽取、转换和加载的过程。同时将客户端的处理数据的压力转移到了服务器端。从而减轻了客户端处理数据的压力。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#from -- 转账发起人</span>
<span class="token comment">#to -- 转账接收人</span>
<span class="token comment">#time -- 转账时间</span>
<span class="token comment">#money -- 转账金额</span>
use itcast<span class="token punctuation">;</span>
var one <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:100<span class="token punctuation">}</span><span class="token punctuation">;</span>
var two <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:200,<span class="token string">&quot;time&quot;</span>:ISODate<span class="token punctuation">(</span><span class="token string">&quot;2018-05-11T13:58:51.122Z&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
var thr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:300,<span class="token string">&quot;time&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2018-07-10 14:38:50&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
var four <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:100,<span class="token string">&quot;time&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2017-04-16 14:38:50&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
var five <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:500,<span class="token string">&quot;time&quot;</span>:1569569092514<span class="token punctuation">}</span><span class="token punctuation">;</span>
var six <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:500,<span class="token string">&quot;time&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Last Friday&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
db.transfer.insertMany<span class="token punctuation">(</span><span class="token punctuation">[</span>one,two,thr,four,five,six<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们发现上述结果的时间每条转账记录都不一致。非常杂乱。有的转账记录是标准的例如ISODate,有的时间是字符串，有的是使用整数表示，而还有的根本没有转账记录。还有的时间是无效的。</p> <p>那么这个时候我们就可以使用MongoDB4.0引入的数据类型转换的操作符来将转账时间统一为一致的数据类型。</p> <div class="language-js extra-class"><pre class="language-js"><code>conversionStage<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token comment">//聚合通道</span>
    $project<span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token comment">//在数据映射通道中保留原来的数据项，设置为1</span>
        from<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        to<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        money<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        time<span class="token operator">:</span><span class="token punctuation">{</span><span class="token comment">//转账时间需要做一些类型的转换</span>
            <span class="token comment">//转换操作符</span>
            $convert<span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token comment">//必须书写的 原来的转账时间</span>
                input<span class="token operator">:</span><span class="token string">&quot;$time&quot;</span><span class="token punctuation">,</span>
                <span class="token comment">//必须书写的 希望把这一项数据转换哪种类型，date就是mongo的标准时间类型ISODate</span>
                to<span class="token operator">:</span><span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span>
                <span class="token comment">//onError这一项是可选的。对于存在的属性，但是属性值是完全没有办法转换为标准的日期格式，可以对其显示。</span>
                onError<span class="token operator">:</span><span class="token punctuation">{</span>
                	<span class="token comment">//$concat表示字段拼接操作符</span>
                    $concat<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;can not convert &quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>$toString<span class="token operator">:</span><span class="token string">&quot;$time&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot; to date type&quot;</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">//缺失转账时间这一项，可以对其提示</span>
                onNull<span class="token operator">:</span><span class="token string">&quot;missing time&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>使用聚合函数aggregate()处理上述数据。执行转换操作</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#db.集合名.aggregate([聚合操作内容])</span>
db.transfer.aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span>conversionStage<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/doc-vuepress/assets/js/app.b1672c91.js" defer></script><script src="/doc-vuepress/assets/js/2.3b3db5cf.js" defer></script><script src="/doc-vuepress/assets/js/130.c52db2c9.js" defer></script>
  </body>
</html>
